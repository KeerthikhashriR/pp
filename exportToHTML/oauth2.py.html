<html>
<head>
<title>oauth2.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
oauth2.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">Dict</span><span class="s2">, </span><span class="s1">List</span><span class="s2">, </span><span class="s1">Optional</span><span class="s2">, </span><span class="s1">Union</span><span class="s2">, </span><span class="s1">cast</span>

<span class="s0">from </span><span class="s1">fastapi</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">HTTPException</span>
<span class="s0">from </span><span class="s1">fastapi</span><span class="s2">.</span><span class="s1">openapi</span><span class="s2">.</span><span class="s1">models </span><span class="s0">import </span><span class="s1">OAuth2 </span><span class="s0">as </span><span class="s1">OAuth2Model</span>
<span class="s0">from </span><span class="s1">fastapi</span><span class="s2">.</span><span class="s1">openapi</span><span class="s2">.</span><span class="s1">models </span><span class="s0">import </span><span class="s1">OAuthFlows </span><span class="s0">as </span><span class="s1">OAuthFlowsModel</span>
<span class="s0">from </span><span class="s1">fastapi</span><span class="s2">.</span><span class="s1">param_functions </span><span class="s0">import </span><span class="s1">Form</span>
<span class="s0">from </span><span class="s1">fastapi</span><span class="s2">.</span><span class="s1">security</span><span class="s2">.</span><span class="s1">base </span><span class="s0">import </span><span class="s1">SecurityBase</span>
<span class="s0">from </span><span class="s1">fastapi</span><span class="s2">.</span><span class="s1">security</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s1">get_authorization_scheme_param</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">requests </span><span class="s0">import </span><span class="s1">Request</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">status </span><span class="s0">import </span><span class="s1">HTTP_401_UNAUTHORIZED</span><span class="s2">, </span><span class="s1">HTTP_403_FORBIDDEN</span>

<span class="s3"># TODO: import from typing when deprecating Python 3.9</span>
<span class="s0">from </span><span class="s1">typing_extensions </span><span class="s0">import </span><span class="s1">Annotated</span><span class="s2">, </span><span class="s1">Doc</span>


<span class="s0">class </span><span class="s1">OAuth2PasswordRequestForm</span><span class="s2">:</span>
    <span class="s4">&quot;&quot;&quot; 
    This is a dependency class to collect the `username` and `password` as form data 
    for an OAuth2 password flow. 
 
    The OAuth2 specification dictates that for a password flow the data should be 
    collected using form data (instead of JSON) and that it should have the specific 
    fields `username` and `password`. 
 
    All the initialization parameters are extracted from the request. 
 
    Read more about it in the 
    [FastAPI docs for Simple OAuth2 with Password and Bearer](https://fastapi.tiangolo.com/tutorial/security/simple-oauth2/). 
 
    ## Example 
 
    ```python 
    from typing import Annotated 
 
    from fastapi import Depends, FastAPI 
    from fastapi.security import OAuth2PasswordRequestForm 
 
    app = FastAPI() 
 
 
    @app.post(&quot;/login&quot;) 
    def login(form_data: Annotated[OAuth2PasswordRequestForm, Depends()]): 
        data = {} 
        data[&quot;scopes&quot;] = [] 
        for scope in form_data.scopes: 
            data[&quot;scopes&quot;].append(scope) 
        if form_data.client_id: 
            data[&quot;client_id&quot;] = form_data.client_id 
        if form_data.client_secret: 
            data[&quot;client_secret&quot;] = form_data.client_secret 
        return data 
    ``` 
 
    Note that for OAuth2 the scope `items:read` is a single scope in an opaque string. 
    You could have custom internal logic to separate it by colon characters (`:`) or 
    similar, and get the two parts `items` and `read`. Many applications do that to 
    group and organize permissions, you could do it as well in your application, just 
    know that that it is application specific, it's not part of the specification. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s2">*,</span>
        <span class="s1">grant_type</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
            <span class="s1">Form</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">=</span><span class="s5">&quot;^password$&quot;</span><span class="s2">),</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                The OAuth2 spec says it is required and MUST be the fixed string 
                &quot;password&quot;. Nevertheless, this dependency class is permissive and 
                allows not passing it. If you want to enforce it, use instead the 
                `OAuth2PasswordRequestFormStrict` dependency. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">username</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">str</span><span class="s2">,</span>
            <span class="s1">Form</span><span class="s2">(),</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                `username` string. The OAuth2 spec requires the exact field name 
                `username`. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
        <span class="s1">password</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">str</span><span class="s2">,</span>
            <span class="s1">Form</span><span class="s2">(),</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                `password` string. The OAuth2 spec requires the exact field name 
                `password&quot;. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
        <span class="s1">scope</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">str</span><span class="s2">,</span>
            <span class="s1">Form</span><span class="s2">(),</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                A single string with actually several scopes separated by spaces. Each 
                scope is also a string. 
 
                For example, a single string with: 
 
                ```python 
                &quot;items:read items:write users:read profile openid&quot; 
                ```` 
 
                would represent the scopes: 
 
                * `items:read` 
                * `items:write` 
                * `users:read` 
                * `profile` 
                * `openid` 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s5">&quot;&quot;</span><span class="s2">,</span>
        <span class="s1">client_id</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
            <span class="s1">Form</span><span class="s2">(),</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                If there's a `client_id`, it can be sent as part of the form fields. 
                But the OAuth2 specification recommends sending the `client_id` and 
                `client_secret` (if any) using HTTP Basic auth. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">client_secret</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
            <span class="s1">Form</span><span class="s2">(),</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                If there's a `client_password` (and a `client_id`), they can be sent 
                as part of the form fields. But the OAuth2 specification recommends 
                sending the `client_id` and `client_secret` (if any) using HTTP Basic 
                auth. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">grant_type </span><span class="s2">= </span><span class="s1">grant_type</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">username </span><span class="s2">= </span><span class="s1">username</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">password </span><span class="s2">= </span><span class="s1">password</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scopes </span><span class="s2">= </span><span class="s1">scope</span><span class="s2">.</span><span class="s1">split</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">client_id </span><span class="s2">= </span><span class="s1">client_id</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">client_secret </span><span class="s2">= </span><span class="s1">client_secret</span>


<span class="s0">class </span><span class="s1">OAuth2PasswordRequestFormStrict</span><span class="s2">(</span><span class="s1">OAuth2PasswordRequestForm</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    This is a dependency class to collect the `username` and `password` as form data 
    for an OAuth2 password flow. 
 
    The OAuth2 specification dictates that for a password flow the data should be 
    collected using form data (instead of JSON) and that it should have the specific 
    fields `username` and `password`. 
 
    All the initialization parameters are extracted from the request. 
 
    The only difference between `OAuth2PasswordRequestFormStrict` and 
    `OAuth2PasswordRequestForm` is that `OAuth2PasswordRequestFormStrict` requires the 
    client to send the form field `grant_type` with the value `&quot;password&quot;`, which 
    is required in the OAuth2 specification (it seems that for no particular reason), 
    while for `OAuth2PasswordRequestForm` `grant_type` is optional. 
 
    Read more about it in the 
    [FastAPI docs for Simple OAuth2 with Password and Bearer](https://fastapi.tiangolo.com/tutorial/security/simple-oauth2/). 
 
    ## Example 
 
    ```python 
    from typing import Annotated 
 
    from fastapi import Depends, FastAPI 
    from fastapi.security import OAuth2PasswordRequestForm 
 
    app = FastAPI() 
 
 
    @app.post(&quot;/login&quot;) 
    def login(form_data: Annotated[OAuth2PasswordRequestFormStrict, Depends()]): 
        data = {} 
        data[&quot;scopes&quot;] = [] 
        for scope in form_data.scopes: 
            data[&quot;scopes&quot;].append(scope) 
        if form_data.client_id: 
            data[&quot;client_id&quot;] = form_data.client_id 
        if form_data.client_secret: 
            data[&quot;client_secret&quot;] = form_data.client_secret 
        return data 
    ``` 
 
    Note that for OAuth2 the scope `items:read` is a single scope in an opaque string. 
    You could have custom internal logic to separate it by colon characters (`:`) or 
    similar, and get the two parts `items` and `read`. Many applications do that to 
    group and organize permissions, you could do it as well in your application, just 
    know that that it is application specific, it's not part of the specification. 
 
 
    grant_type: the OAuth2 spec says it is required and MUST be the fixed string &quot;password&quot;. 
        This dependency is strict about it. If you want to be permissive, use instead the 
        OAuth2PasswordRequestForm dependency class. 
    username: username string. The OAuth2 spec requires the exact field name &quot;username&quot;. 
    password: password string. The OAuth2 spec requires the exact field name &quot;password&quot;. 
    scope: Optional string. Several scopes (each one a string) separated by spaces. E.g. 
        &quot;items:read items:write users:read profile openid&quot; 
    client_id: optional string. OAuth2 recommends sending the client_id and client_secret (if any) 
        using HTTP Basic auth, as: client_id:client_secret 
    client_secret: optional string. OAuth2 recommends sending the client_id and client_secret (if any) 
        using HTTP Basic auth, as: client_id:client_secret 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">grant_type</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">str</span><span class="s2">,</span>
            <span class="s1">Form</span><span class="s2">(</span><span class="s1">pattern</span><span class="s2">=</span><span class="s5">&quot;^password$&quot;</span><span class="s2">),</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                The OAuth2 spec says it is required and MUST be the fixed string 
                &quot;password&quot;. This dependency is strict about it. If you want to be 
                permissive, use instead the `OAuth2PasswordRequestForm` dependency 
                class. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
        <span class="s1">username</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">str</span><span class="s2">,</span>
            <span class="s1">Form</span><span class="s2">(),</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                `username` string. The OAuth2 spec requires the exact field name 
                `username`. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
        <span class="s1">password</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">str</span><span class="s2">,</span>
            <span class="s1">Form</span><span class="s2">(),</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                `password` string. The OAuth2 spec requires the exact field name 
                `password&quot;. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
        <span class="s1">scope</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">str</span><span class="s2">,</span>
            <span class="s1">Form</span><span class="s2">(),</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                A single string with actually several scopes separated by spaces. Each 
                scope is also a string. 
 
                For example, a single string with: 
 
                ```python 
                &quot;items:read items:write users:read profile openid&quot; 
                ```` 
 
                would represent the scopes: 
 
                * `items:read` 
                * `items:write` 
                * `users:read` 
                * `profile` 
                * `openid` 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s5">&quot;&quot;</span><span class="s2">,</span>
        <span class="s1">client_id</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
            <span class="s1">Form</span><span class="s2">(),</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                If there's a `client_id`, it can be sent as part of the form fields. 
                But the OAuth2 specification recommends sending the `client_id` and 
                `client_secret` (if any) using HTTP Basic auth. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">client_secret</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Union</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
            <span class="s1">Form</span><span class="s2">(),</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                If there's a `client_password` (and a `client_id`), they can be sent 
                as part of the form fields. But the OAuth2 specification recommends 
                sending the `client_id` and `client_secret` (if any) using HTTP Basic 
                auth. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">grant_type</span><span class="s2">=</span><span class="s1">grant_type</span><span class="s2">,</span>
            <span class="s1">username</span><span class="s2">=</span><span class="s1">username</span><span class="s2">,</span>
            <span class="s1">password</span><span class="s2">=</span><span class="s1">password</span><span class="s2">,</span>
            <span class="s1">scope</span><span class="s2">=</span><span class="s1">scope</span><span class="s2">,</span>
            <span class="s1">client_id</span><span class="s2">=</span><span class="s1">client_id</span><span class="s2">,</span>
            <span class="s1">client_secret</span><span class="s2">=</span><span class="s1">client_secret</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s0">class </span><span class="s1">OAuth2</span><span class="s2">(</span><span class="s1">SecurityBase</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    This is the base class for OAuth2 authentication, an instance of it would be used 
    as a dependency. All other OAuth2 classes inherit from it and customize it for 
    each OAuth2 flow. 
 
    You normally would not create a new class inheriting from it but use one of the 
    existing subclasses, and maybe compose them if you want to support multiple flows. 
 
    Read more about it in the 
    [FastAPI docs for Security](https://fastapi.tiangolo.com/tutorial/security/). 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s2">*,</span>
        <span class="s1">flows</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Union</span><span class="s2">[</span><span class="s1">OAuthFlowsModel</span><span class="s2">, </span><span class="s1">Dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">]]],</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                The dictionary of OAuth2 flows. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s1">OAuthFlowsModel</span><span class="s2">(),</span>
        <span class="s1">scheme_name</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                Security scheme name. 
 
                It will be included in the generated OpenAPI (e.g. visible at `/docs`). 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">description</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                Security scheme description. 
 
                It will be included in the generated OpenAPI (e.g. visible at `/docs`). 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">auto_error</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">bool</span><span class="s2">,</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                By default, if no HTTP Authorization header is provided, required for 
                OAuth2 authentication, it will automatically cancel the request and 
                send the client an error. 
 
                If `auto_error` is set to `False`, when the HTTP Authorization header 
                is not available, instead of erroring out, the dependency result will 
                be `None`. 
 
                This is useful when you want to have optional authentication. 
 
                It is also useful when you want to have authentication that can be 
                provided in one of multiple optional ways (for example, with OAuth2 
                or in a cookie). 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">model </span><span class="s2">= </span><span class="s1">OAuth2Model</span><span class="s2">(</span>
            <span class="s1">flows</span><span class="s2">=</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">OAuthFlowsModel</span><span class="s2">, </span><span class="s1">flows</span><span class="s2">), </span><span class="s1">description</span><span class="s2">=</span><span class="s1">description</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scheme_name </span><span class="s2">= </span><span class="s1">scheme_name </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">auto_error </span><span class="s2">= </span><span class="s1">auto_error</span>

    <span class="s0">async def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">: </span><span class="s1">Request</span><span class="s2">) </span><span class="s1">-&gt; Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]:</span>
        <span class="s1">authorization </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">&quot;Authorization&quot;</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">authorization</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">auto_error</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">HTTPException</span><span class="s2">(</span>
                    <span class="s1">status_code</span><span class="s2">=</span><span class="s1">HTTP_403_FORBIDDEN</span><span class="s2">, </span><span class="s1">detail</span><span class="s2">=</span><span class="s5">&quot;Not authenticated&quot;</span>
                <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">return None</span>
        <span class="s0">return </span><span class="s1">authorization</span>


<span class="s0">class </span><span class="s1">OAuth2PasswordBearer</span><span class="s2">(</span><span class="s1">OAuth2</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    OAuth2 flow for authentication using a bearer token obtained with a password. 
    An instance of it would be used as a dependency. 
 
    Read more about it in the 
    [FastAPI docs for Simple OAuth2 with Password and Bearer](https://fastapi.tiangolo.com/tutorial/security/simple-oauth2/). 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">tokenUrl</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">str</span><span class="s2">,</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                The URL to obtain the OAuth2 token. This would be the *path operation* 
                that has `OAuth2PasswordRequestForm` as a dependency. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
        <span class="s1">scheme_name</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                Security scheme name. 
 
                It will be included in the generated OpenAPI (e.g. visible at `/docs`). 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">scopes</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Optional</span><span class="s2">[</span><span class="s1">Dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]],</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                The OAuth2 scopes that would be required by the *path operations* that 
                use this dependency. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">description</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                Security scheme description. 
 
                It will be included in the generated OpenAPI (e.g. visible at `/docs`). 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">auto_error</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">bool</span><span class="s2">,</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                By default, if no HTTP Authorization header is provided, required for 
                OAuth2 authentication, it will automatically cancel the request and 
                send the client an error. 
 
                If `auto_error` is set to `False`, when the HTTP Authorization header 
                is not available, instead of erroring out, the dependency result will 
                be `None`. 
 
                This is useful when you want to have optional authentication. 
 
                It is also useful when you want to have authentication that can be 
                provided in one of multiple optional ways (for example, with OAuth2 
                or in a cookie). 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">scopes</span><span class="s2">:</span>
            <span class="s1">scopes </span><span class="s2">= {}</span>
        <span class="s1">flows </span><span class="s2">= </span><span class="s1">OAuthFlowsModel</span><span class="s2">(</span>
            <span class="s1">password</span><span class="s2">=</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">Any</span><span class="s2">, {</span><span class="s5">&quot;tokenUrl&quot;</span><span class="s2">: </span><span class="s1">tokenUrl</span><span class="s2">, </span><span class="s5">&quot;scopes&quot;</span><span class="s2">: </span><span class="s1">scopes</span><span class="s2">})</span>
        <span class="s2">)</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">flows</span><span class="s2">=</span><span class="s1">flows</span><span class="s2">,</span>
            <span class="s1">scheme_name</span><span class="s2">=</span><span class="s1">scheme_name</span><span class="s2">,</span>
            <span class="s1">description</span><span class="s2">=</span><span class="s1">description</span><span class="s2">,</span>
            <span class="s1">auto_error</span><span class="s2">=</span><span class="s1">auto_error</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">: </span><span class="s1">Request</span><span class="s2">) </span><span class="s1">-&gt; Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]:</span>
        <span class="s1">authorization </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">&quot;Authorization&quot;</span><span class="s2">)</span>
        <span class="s1">scheme</span><span class="s2">, </span><span class="s1">param </span><span class="s2">= </span><span class="s1">get_authorization_scheme_param</span><span class="s2">(</span><span class="s1">authorization</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">authorization </span><span class="s0">or </span><span class="s1">scheme</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() != </span><span class="s5">&quot;bearer&quot;</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">auto_error</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">HTTPException</span><span class="s2">(</span>
                    <span class="s1">status_code</span><span class="s2">=</span><span class="s1">HTTP_401_UNAUTHORIZED</span><span class="s2">,</span>
                    <span class="s1">detail</span><span class="s2">=</span><span class="s5">&quot;Not authenticated&quot;</span><span class="s2">,</span>
                    <span class="s1">headers</span><span class="s2">={</span><span class="s5">&quot;WWW-Authenticate&quot;</span><span class="s2">: </span><span class="s5">&quot;Bearer&quot;</span><span class="s2">},</span>
                <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">return None</span>
        <span class="s0">return </span><span class="s1">param</span>


<span class="s0">class </span><span class="s1">OAuth2AuthorizationCodeBearer</span><span class="s2">(</span><span class="s1">OAuth2</span><span class="s2">):</span>
    <span class="s4">&quot;&quot;&quot; 
    OAuth2 flow for authentication using a bearer token obtained with an OAuth2 code 
    flow. An instance of it would be used as a dependency. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">authorizationUrl</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
        <span class="s1">tokenUrl</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">str</span><span class="s2">,</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                The URL to obtain the OAuth2 token. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">],</span>
        <span class="s1">refreshUrl</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                The URL to refresh the token and obtain a new one. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">scheme_name</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                Security scheme name. 
 
                It will be included in the generated OpenAPI (e.g. visible at `/docs`). 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">scopes</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Optional</span><span class="s2">[</span><span class="s1">Dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]],</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                The OAuth2 scopes that would be required by the *path operations* that 
                use this dependency. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">description</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                Security scheme description. 
 
                It will be included in the generated OpenAPI (e.g. visible at `/docs`). 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">auto_error</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">bool</span><span class="s2">,</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                By default, if no HTTP Authorization header is provided, required for 
                OAuth2 authentication, it will automatically cancel the request and 
                send the client an error. 
 
                If `auto_error` is set to `False`, when the HTTP Authorization header 
                is not available, instead of erroring out, the dependency result will 
                be `None`. 
 
                This is useful when you want to have optional authentication. 
 
                It is also useful when you want to have authentication that can be 
                provided in one of multiple optional ways (for example, with OAuth2 
                or in a cookie). 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">scopes</span><span class="s2">:</span>
            <span class="s1">scopes </span><span class="s2">= {}</span>
        <span class="s1">flows </span><span class="s2">= </span><span class="s1">OAuthFlowsModel</span><span class="s2">(</span>
            <span class="s1">authorizationCode</span><span class="s2">=</span><span class="s1">cast</span><span class="s2">(</span>
                <span class="s1">Any</span><span class="s2">,</span>
                <span class="s2">{</span>
                    <span class="s5">&quot;authorizationUrl&quot;</span><span class="s2">: </span><span class="s1">authorizationUrl</span><span class="s2">,</span>
                    <span class="s5">&quot;tokenUrl&quot;</span><span class="s2">: </span><span class="s1">tokenUrl</span><span class="s2">,</span>
                    <span class="s5">&quot;refreshUrl&quot;</span><span class="s2">: </span><span class="s1">refreshUrl</span><span class="s2">,</span>
                    <span class="s5">&quot;scopes&quot;</span><span class="s2">: </span><span class="s1">scopes</span><span class="s2">,</span>
                <span class="s2">},</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">flows</span><span class="s2">=</span><span class="s1">flows</span><span class="s2">,</span>
            <span class="s1">scheme_name</span><span class="s2">=</span><span class="s1">scheme_name</span><span class="s2">,</span>
            <span class="s1">description</span><span class="s2">=</span><span class="s1">description</span><span class="s2">,</span>
            <span class="s1">auto_error</span><span class="s2">=</span><span class="s1">auto_error</span><span class="s2">,</span>
        <span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">request</span><span class="s2">: </span><span class="s1">Request</span><span class="s2">) </span><span class="s1">-&gt; Optional</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]:</span>
        <span class="s1">authorization </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s5">&quot;Authorization&quot;</span><span class="s2">)</span>
        <span class="s1">scheme</span><span class="s2">, </span><span class="s1">param </span><span class="s2">= </span><span class="s1">get_authorization_scheme_param</span><span class="s2">(</span><span class="s1">authorization</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s1">authorization </span><span class="s0">or </span><span class="s1">scheme</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() != </span><span class="s5">&quot;bearer&quot;</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">auto_error</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">HTTPException</span><span class="s2">(</span>
                    <span class="s1">status_code</span><span class="s2">=</span><span class="s1">HTTP_401_UNAUTHORIZED</span><span class="s2">,</span>
                    <span class="s1">detail</span><span class="s2">=</span><span class="s5">&quot;Not authenticated&quot;</span><span class="s2">,</span>
                    <span class="s1">headers</span><span class="s2">={</span><span class="s5">&quot;WWW-Authenticate&quot;</span><span class="s2">: </span><span class="s5">&quot;Bearer&quot;</span><span class="s2">},</span>
                <span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">return None  </span><span class="s3"># pragma: nocover</span>
        <span class="s0">return </span><span class="s1">param</span>


<span class="s0">class </span><span class="s1">SecurityScopes</span><span class="s2">:</span>
    <span class="s4">&quot;&quot;&quot; 
    This is a special class that you can define in a parameter in a dependency to 
    obtain the OAuth2 scopes required by all the dependencies in the same chain. 
 
    This way, multiple dependencies can have different scopes, even when used in the 
    same *path operation*. And with this, you can access all the scopes required in 
    all those dependencies in a single place. 
 
    Read more about it in the 
    [FastAPI docs for OAuth2 scopes](https://fastapi.tiangolo.com/advanced/security/oauth2-scopes/). 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">scopes</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">Optional</span><span class="s2">[</span><span class="s1">List</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]],</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                This will be filled by FastAPI. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scopes</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">List</span><span class="s2">[</span><span class="s1">str</span><span class="s2">],</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                The list of all the scopes required by dependencies. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s1">scopes </span><span class="s0">or </span><span class="s2">[]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scope_str</span><span class="s2">: </span><span class="s1">Annotated</span><span class="s2">[</span>
            <span class="s1">str</span><span class="s2">,</span>
            <span class="s1">Doc</span><span class="s2">(</span>
                <span class="s5">&quot;&quot;&quot; 
                All the scopes required by all the dependencies in a single string 
                separated by spaces, as defined in the OAuth2 specification. 
                &quot;&quot;&quot;</span>
            <span class="s2">),</span>
        <span class="s2">] = </span><span class="s5">&quot; &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scopes</span><span class="s2">)</span>
</pre>
</body>
</html>