<html>
<head>
<title>requests.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #5f826b; font-style: italic;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
requests.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">json</span>
<span class="s0">import </span><span class="s1">typing</span>
<span class="s0">from </span><span class="s1">http </span><span class="s0">import </span><span class="s1">cookies </span><span class="s0">as </span><span class="s1">http_cookies</span>

<span class="s0">import </span><span class="s1">anyio</span>

<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">_utils </span><span class="s0">import </span><span class="s1">AwaitableOrContextManager</span><span class="s2">, </span><span class="s1">AwaitableOrContextManagerWrapper</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">datastructures </span><span class="s0">import </span><span class="s1">URL</span><span class="s2">, </span><span class="s1">Address</span><span class="s2">, </span><span class="s1">FormData</span><span class="s2">, </span><span class="s1">Headers</span><span class="s2">, </span><span class="s1">QueryParams</span><span class="s2">, </span><span class="s1">State</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">HTTPException</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">formparsers </span><span class="s0">import </span><span class="s1">FormParser</span><span class="s2">, </span><span class="s1">MultiPartException</span><span class="s2">, </span><span class="s1">MultiPartParser</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">types </span><span class="s0">import </span><span class="s1">Message</span><span class="s2">, </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">Send</span>

<span class="s0">if </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">TYPE_CHECKING</span><span class="s2">:</span>
    <span class="s0">from </span><span class="s1">python_multipart</span><span class="s2">.</span><span class="s1">multipart </span><span class="s0">import </span><span class="s1">parse_options_header</span>

    <span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">applications </span><span class="s0">import </span><span class="s1">Starlette</span>
    <span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">routing </span><span class="s0">import </span><span class="s1">Router</span>
<span class="s0">else</span><span class="s2">:</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">from </span><span class="s1">python_multipart</span><span class="s2">.</span><span class="s1">multipart </span><span class="s0">import </span><span class="s1">parse_options_header</span>
        <span class="s0">except </span><span class="s1">ModuleNotFoundError</span><span class="s2">:  </span><span class="s3"># pragma: no cover</span>
            <span class="s0">from </span><span class="s1">multipart</span><span class="s2">.</span><span class="s1">multipart </span><span class="s0">import </span><span class="s1">parse_options_header</span>
    <span class="s0">except </span><span class="s1">ModuleNotFoundError</span><span class="s2">:  </span><span class="s3"># pragma: no cover</span>
        <span class="s1">parse_options_header </span><span class="s2">= </span><span class="s0">None</span>


<span class="s1">SERVER_PUSH_HEADERS_TO_COPY </span><span class="s2">= {</span>
    <span class="s4">&quot;accept&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;accept-encoding&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;accept-language&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;cache-control&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;user-agent&quot;</span><span class="s2">,</span>
<span class="s2">}</span>


<span class="s0">def </span><span class="s1">cookie_parser</span><span class="s2">(</span><span class="s1">cookie_string</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]:</span>
    <span class="s5">&quot;&quot;&quot; 
    This function parses a ``Cookie`` HTTP header into a dict of key/value pairs. 
 
    It attempts to mimic browser cookie parsing behavior: browsers and web servers 
    frequently disregard the spec (RFC 6265) when setting and reading cookies, 
    so we attempt to suit the common scenarios here. 
 
    This function has been adapted from Django 3.1.0. 
    Note: we are explicitly _NOT_ using `SimpleCookie.load` because it is based 
    on an outdated spec and will fail on lots of input we want to support 
    &quot;&quot;&quot;</span>
    <span class="s1">cookie_dict</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">] = {}</span>
    <span class="s0">for </span><span class="s1">chunk </span><span class="s0">in </span><span class="s1">cookie_string</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s4">&quot;;&quot;</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s4">&quot;=&quot; </span><span class="s0">in </span><span class="s1">chunk</span><span class="s2">:</span>
            <span class="s1">key</span><span class="s2">, </span><span class="s1">val </span><span class="s2">= </span><span class="s1">chunk</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s4">&quot;=&quot;</span><span class="s2">, </span><span class="s6">1</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s3"># Assume an empty name per</span>
            <span class="s3"># https://bugzilla.mozilla.org/show_bug.cgi?id=169091</span>
            <span class="s1">key</span><span class="s2">, </span><span class="s1">val </span><span class="s2">= </span><span class="s4">&quot;&quot;</span><span class="s2">, </span><span class="s1">chunk</span>
        <span class="s1">key</span><span class="s2">, </span><span class="s1">val </span><span class="s2">= </span><span class="s1">key</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(), </span><span class="s1">val</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
        <span class="s0">if </span><span class="s1">key </span><span class="s0">or </span><span class="s1">val</span><span class="s2">:</span>
            <span class="s3"># unquote using Python's algorithm.</span>
            <span class="s1">cookie_dict</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">http_cookies</span><span class="s2">.</span><span class="s1">_unquote</span><span class="s2">(</span><span class="s1">val</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">cookie_dict</span>


<span class="s0">class </span><span class="s1">ClientDisconnect</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
    <span class="s0">pass</span>


<span class="s0">class </span><span class="s1">HTTPConnection</span><span class="s2">(</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Mapping</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]):</span>
    <span class="s5">&quot;&quot;&quot; 
    A base class for incoming HTTP connections, that is used to provide 
    any functionality that is common to both `Request` and `WebSocket`. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;http&quot;</span><span class="s2">, </span><span class="s4">&quot;websocket&quot;</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">= </span><span class="s1">scope</span>

    <span class="s0">def </span><span class="s1">__getitem__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">__iter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Iterator</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]:</span>
        <span class="s0">return </span><span class="s1">iter</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__len__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; int</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">)</span>

    <span class="s3"># Don't use the `abc.Mapping.__eq__` implementation.</span>
    <span class="s3"># Connection instances should never be considered equal</span>
    <span class="s3"># unless `self is other`.</span>
    <span class="s1">__eq__ </span><span class="s2">= </span><span class="s1">object</span><span class="s2">.</span><span class="s1">__eq__</span>
    <span class="s1">__hash__ </span><span class="s2">= </span><span class="s1">object</span><span class="s2">.</span><span class="s1">__hash__</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">app</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;app&quot;</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">url</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; URL</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">&quot;_url&quot;</span><span class="s2">):  </span><span class="s3"># pragma: no branch</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_url </span><span class="s2">= </span><span class="s1">URL</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_url</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">base_url</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; URL</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">&quot;_base_url&quot;</span><span class="s2">):</span>
            <span class="s1">base_url_scope </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">)</span>
            <span class="s3"># This is used by request.url_for, it might be used inside a Mount which</span>
            <span class="s3"># would have its own child scope with its own root_path, but the base URL</span>
            <span class="s3"># for url_for should still be the top level app root path.</span>
            <span class="s1">app_root_path </span><span class="s2">= </span><span class="s1">base_url_scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;app_root_path&quot;</span><span class="s2">, </span><span class="s1">base_url_scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;root_path&quot;</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">))</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">app_root_path</span>
            <span class="s0">if not </span><span class="s1">path</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">&quot;/&quot;</span><span class="s2">):</span>
                <span class="s1">path </span><span class="s2">+= </span><span class="s4">&quot;/&quot;</span>
            <span class="s1">base_url_scope</span><span class="s2">[</span><span class="s4">&quot;path&quot;</span><span class="s2">] = </span><span class="s1">path</span>
            <span class="s1">base_url_scope</span><span class="s2">[</span><span class="s4">&quot;query_string&quot;</span><span class="s2">] = </span><span class="s7">b&quot;&quot;</span>
            <span class="s1">base_url_scope</span><span class="s2">[</span><span class="s4">&quot;root_path&quot;</span><span class="s2">] = </span><span class="s1">app_root_path</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_base_url </span><span class="s2">= </span><span class="s1">URL</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s1">base_url_scope</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_base_url</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">headers</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; Headers</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">&quot;_headers&quot;</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_headers </span><span class="s2">= </span><span class="s1">Headers</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_headers</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">query_params</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; QueryParams</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">&quot;_query_params&quot;</span><span class="s2">):  </span><span class="s3"># pragma: no branch</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_query_params </span><span class="s2">= </span><span class="s1">QueryParams</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;query_string&quot;</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_query_params</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">path_params</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;path_params&quot;</span><span class="s2">, {})</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">cookies</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]:</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">&quot;_cookies&quot;</span><span class="s2">):</span>
            <span class="s1">cookies</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">] = {}</span>
            <span class="s1">cookie_header </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;cookie&quot;</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">cookie_header</span><span class="s2">:</span>
                <span class="s1">cookies </span><span class="s2">= </span><span class="s1">cookie_parser</span><span class="s2">(</span><span class="s1">cookie_header</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_cookies </span><span class="s2">= </span><span class="s1">cookies</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cookies</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">client</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; Address </span><span class="s2">| </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s3"># client is a 2 item tuple of (host, port), None if missing</span>
        <span class="s1">host_port </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;client&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">host_port </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">Address</span><span class="s2">(*</span><span class="s1">host_port</span><span class="s2">)</span>
        <span class="s0">return None</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">session</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]:</span>
        <span class="s0">assert </span><span class="s4">&quot;session&quot; </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">, </span><span class="s4">&quot;SessionMiddleware must be installed to access request.session&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;session&quot;</span><span class="s2">]  </span><span class="s3"># type: ignore[no-any-return]</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">auth</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s4">&quot;auth&quot; </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">, </span><span class="s4">&quot;AuthenticationMiddleware must be installed to access request.auth&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;auth&quot;</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">user</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s4">&quot;user&quot; </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">, </span><span class="s4">&quot;AuthenticationMiddleware must be installed to access request.user&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;user&quot;</span><span class="s2">]</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">state</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; State</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">&quot;_state&quot;</span><span class="s2">):</span>
            <span class="s3"># Ensure 'state' has an empty dict if it's not already populated.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">.</span><span class="s1">setdefault</span><span class="s2">(</span><span class="s4">&quot;state&quot;</span><span class="s2">, {})</span>
            <span class="s3"># Create a state instance with a reference to the dict in which it should</span>
            <span class="s3"># store info</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_state </span><span class="s2">= </span><span class="s1">State</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;state&quot;</span><span class="s2">])</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_state</span>

    <span class="s0">def </span><span class="s1">url_for</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, /, **</span><span class="s1">path_params</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; URL</span><span class="s2">:</span>
        <span class="s1">url_path_provider</span><span class="s2">: </span><span class="s1">Router </span><span class="s2">| </span><span class="s1">Starlette </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;router&quot;</span><span class="s2">) </span><span class="s0">or </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;app&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">url_path_provider </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">&quot;The `url_for` method can only be used inside a Starlette application or with a router.&quot;</span><span class="s2">)</span>
        <span class="s1">url_path </span><span class="s2">= </span><span class="s1">url_path_provider</span><span class="s2">.</span><span class="s1">url_path_for</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, **</span><span class="s1">path_params</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">url_path</span><span class="s2">.</span><span class="s1">make_absolute_url</span><span class="s2">(</span><span class="s1">base_url</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">base_url</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">empty_receive</span><span class="s2">() </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">NoReturn</span><span class="s2">:</span>
    <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">&quot;Receive channel has not been made available&quot;</span><span class="s2">)</span>


<span class="s0">async def </span><span class="s1">empty_send</span><span class="s2">(</span><span class="s1">message</span><span class="s2">: </span><span class="s1">Message</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">NoReturn</span><span class="s2">:</span>
    <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">&quot;Send channel has not been made available&quot;</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Request</span><span class="s2">(</span><span class="s1">HTTPConnection</span><span class="s2">):</span>
    <span class="s1">_form</span><span class="s2">: </span><span class="s1">FormData </span><span class="s2">| </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive </span><span class="s2">= </span><span class="s1">empty_receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send </span><span class="s2">= </span><span class="s1">empty_send</span><span class="s2">):</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] == </span><span class="s4">&quot;http&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_receive </span><span class="s2">= </span><span class="s1">receive</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_send </span><span class="s2">= </span><span class="s1">send</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_stream_consumed </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_is_disconnected </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_form </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">cast</span><span class="s2">(</span><span class="s1">str</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;method&quot;</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">receive</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; Receive</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_receive</span>

    <span class="s0">async def </span><span class="s1">stream</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">AsyncGenerator</span><span class="s2">[</span><span class="s1">bytes</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]:</span>
        <span class="s0">if </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">&quot;_body&quot;</span><span class="s2">):</span>
            <span class="s0">yield </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_body</span>
            <span class="s0">yield </span><span class="s7">b&quot;&quot;</span>
            <span class="s0">return</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_stream_consumed</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">&quot;Stream consumed&quot;</span><span class="s2">)</span>
        <span class="s0">while not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_stream_consumed</span><span class="s2">:</span>
            <span class="s1">message </span><span class="s2">= </span><span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_receive</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">message</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] == </span><span class="s4">&quot;http.request&quot;</span><span class="s2">:</span>
                <span class="s1">body </span><span class="s2">= </span><span class="s1">message</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;body&quot;</span><span class="s2">, </span><span class="s7">b&quot;&quot;</span><span class="s2">)</span>
                <span class="s0">if not </span><span class="s1">message</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;more_body&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_stream_consumed </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">if </span><span class="s1">body</span><span class="s2">:</span>
                    <span class="s0">yield </span><span class="s1">body</span>
            <span class="s0">elif </span><span class="s1">message</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] == </span><span class="s4">&quot;http.disconnect&quot;</span><span class="s2">:  </span><span class="s3"># pragma: no branch</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_is_disconnected </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">raise </span><span class="s1">ClientDisconnect</span><span class="s2">()</span>
        <span class="s0">yield </span><span class="s7">b&quot;&quot;</span>

    <span class="s0">async def </span><span class="s1">body</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bytes</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">&quot;_body&quot;</span><span class="s2">):</span>
            <span class="s1">chunks</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">bytes</span><span class="s2">] = []</span>
            <span class="s0">async for </span><span class="s1">chunk </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">():</span>
                <span class="s1">chunks</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_body </span><span class="s2">= </span><span class="s7">b&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">chunks</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_body</span>

    <span class="s0">async def </span><span class="s1">json</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s4">&quot;_json&quot;</span><span class="s2">):  </span><span class="s3"># pragma: no branch</span>
            <span class="s1">body </span><span class="s2">= </span><span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">body</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_json </span><span class="s2">= </span><span class="s1">json</span><span class="s2">.</span><span class="s1">loads</span><span class="s2">(</span><span class="s1">body</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_json</span>

    <span class="s0">async def </span><span class="s1">_get_form</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s2">*,</span>
        <span class="s1">max_files</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1000</span><span class="s2">,</span>
        <span class="s1">max_fields</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1000</span><span class="s2">,</span>
        <span class="s1">max_part_size</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">1024 </span><span class="s2">* </span><span class="s6">1024</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; FormData</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_form </span><span class="s0">is None</span><span class="s2">:  </span><span class="s3"># pragma: no branch</span>
            <span class="s0">assert </span><span class="s1">parse_options_header </span><span class="s0">is not None</span><span class="s2">, (</span>
                <span class="s4">&quot;The `python-multipart` library must be installed to use form parsing.&quot;</span>
            <span class="s2">)</span>
            <span class="s1">content_type_header </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;Content-Type&quot;</span><span class="s2">)</span>
            <span class="s1">content_type</span><span class="s2">: </span><span class="s1">bytes</span>
            <span class="s1">content_type</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">parse_options_header</span><span class="s2">(</span><span class="s1">content_type_header</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">content_type </span><span class="s2">== </span><span class="s7">b&quot;multipart/form-data&quot;</span><span class="s2">:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">multipart_parser </span><span class="s2">= </span><span class="s1">MultiPartParser</span><span class="s2">(</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">,</span>
                        <span class="s1">self</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">(),</span>
                        <span class="s1">max_files</span><span class="s2">=</span><span class="s1">max_files</span><span class="s2">,</span>
                        <span class="s1">max_fields</span><span class="s2">=</span><span class="s1">max_fields</span><span class="s2">,</span>
                        <span class="s1">max_part_size</span><span class="s2">=</span><span class="s1">max_part_size</span><span class="s2">,</span>
                    <span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">_form </span><span class="s2">= </span><span class="s0">await </span><span class="s1">multipart_parser</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">()</span>
                <span class="s0">except </span><span class="s1">MultiPartException </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s4">&quot;app&quot; </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">:</span>
                        <span class="s0">raise </span><span class="s1">HTTPException</span><span class="s2">(</span><span class="s1">status_code</span><span class="s2">=</span><span class="s6">400</span><span class="s2">, </span><span class="s1">detail</span><span class="s2">=</span><span class="s1">exc</span><span class="s2">.</span><span class="s1">message</span><span class="s2">)</span>
                    <span class="s0">raise </span><span class="s1">exc</span>
            <span class="s0">elif </span><span class="s1">content_type </span><span class="s2">== </span><span class="s7">b&quot;application/x-www-form-urlencoded&quot;</span><span class="s2">:</span>
                <span class="s1">form_parser </span><span class="s2">= </span><span class="s1">FormParser</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">stream</span><span class="s2">())</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_form </span><span class="s2">= </span><span class="s0">await </span><span class="s1">form_parser</span><span class="s2">.</span><span class="s1">parse</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_form </span><span class="s2">= </span><span class="s1">FormData</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_form</span>

    <span class="s0">def </span><span class="s1">form</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s2">*,</span>
        <span class="s1">max_files</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1000</span><span class="s2">,</span>
        <span class="s1">max_fields</span><span class="s2">: </span><span class="s1">int </span><span class="s2">| </span><span class="s1">float </span><span class="s2">= </span><span class="s6">1000</span><span class="s2">,</span>
        <span class="s1">max_part_size</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s6">1024 </span><span class="s2">* </span><span class="s6">1024</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; AwaitableOrContextManager</span><span class="s2">[</span><span class="s1">FormData</span><span class="s2">]:</span>
        <span class="s0">return </span><span class="s1">AwaitableOrContextManagerWrapper</span><span class="s2">(</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_get_form</span><span class="s2">(</span><span class="s1">max_files</span><span class="s2">=</span><span class="s1">max_files</span><span class="s2">, </span><span class="s1">max_fields</span><span class="s2">=</span><span class="s1">max_fields</span><span class="s2">, </span><span class="s1">max_part_size</span><span class="s2">=</span><span class="s1">max_part_size</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_form </span><span class="s0">is not None</span><span class="s2">:  </span><span class="s3"># pragma: no branch</span>
            <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_form</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s0">async def </span><span class="s1">is_disconnected</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_is_disconnected</span><span class="s2">:</span>
            <span class="s1">message</span><span class="s2">: </span><span class="s1">Message </span><span class="s2">= {}</span>

            <span class="s3"># If message isn't immediately available, move on</span>
            <span class="s0">with </span><span class="s1">anyio</span><span class="s2">.</span><span class="s1">CancelScope</span><span class="s2">() </span><span class="s0">as </span><span class="s1">cs</span><span class="s2">:</span>
                <span class="s1">cs</span><span class="s2">.</span><span class="s1">cancel</span><span class="s2">()</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_receive</span><span class="s2">()</span>

            <span class="s0">if </span><span class="s1">message</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;type&quot;</span><span class="s2">) == </span><span class="s4">&quot;http.disconnect&quot;</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">_is_disconnected </span><span class="s2">= </span><span class="s0">True</span>

        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_is_disconnected</span>

    <span class="s0">async def </span><span class="s1">send_push_promise</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s4">&quot;http.response.push&quot; </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;extensions&quot;</span><span class="s2">, {}):</span>
            <span class="s1">raw_headers</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">tuple</span><span class="s2">[</span><span class="s1">bytes</span><span class="s2">, </span><span class="s1">bytes</span><span class="s2">]] = []</span>
            <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">SERVER_PUSH_HEADERS_TO_COPY</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">value </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">headers</span><span class="s2">.</span><span class="s1">getlist</span><span class="s2">(</span><span class="s1">name</span><span class="s2">):</span>
                    <span class="s1">raw_headers</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">name</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;latin-1&quot;</span><span class="s2">), </span><span class="s1">value</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;latin-1&quot;</span><span class="s2">)))</span>
            <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_send</span><span class="s2">({</span><span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;http.response.push&quot;</span><span class="s2">, </span><span class="s4">&quot;path&quot;</span><span class="s2">: </span><span class="s1">path</span><span class="s2">, </span><span class="s4">&quot;headers&quot;</span><span class="s2">: </span><span class="s1">raw_headers</span><span class="s2">})</span>
</pre>
</body>
</html>