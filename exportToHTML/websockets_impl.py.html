<html>
<head>
<title>websockets_impl.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
websockets_impl.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">asyncio</span>
<span class="s0">import </span><span class="s1">http</span>
<span class="s0">import </span><span class="s1">logging</span>
<span class="s0">from </span><span class="s1">collections</span><span class="s2">.</span><span class="s1">abc </span><span class="s0">import </span><span class="s1">Sequence</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Any</span><span class="s2">, </span><span class="s1">Literal</span><span class="s2">, </span><span class="s1">Optional</span><span class="s2">, </span><span class="s1">cast</span>
<span class="s0">from </span><span class="s1">urllib</span><span class="s2">.</span><span class="s1">parse </span><span class="s0">import </span><span class="s1">unquote</span>

<span class="s0">import </span><span class="s1">websockets</span>
<span class="s0">import </span><span class="s1">websockets</span><span class="s2">.</span><span class="s1">legacy</span><span class="s2">.</span><span class="s1">handshake</span>
<span class="s0">from </span><span class="s1">websockets</span><span class="s2">.</span><span class="s1">datastructures </span><span class="s0">import </span><span class="s1">Headers</span>
<span class="s0">from </span><span class="s1">websockets</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">ConnectionClosed</span>
<span class="s0">from </span><span class="s1">websockets</span><span class="s2">.</span><span class="s1">extensions</span><span class="s2">.</span><span class="s1">base </span><span class="s0">import </span><span class="s1">ServerExtensionFactory</span>
<span class="s0">from </span><span class="s1">websockets</span><span class="s2">.</span><span class="s1">extensions</span><span class="s2">.</span><span class="s1">permessage_deflate </span><span class="s0">import </span><span class="s1">ServerPerMessageDeflateFactory</span>
<span class="s0">from </span><span class="s1">websockets</span><span class="s2">.</span><span class="s1">legacy</span><span class="s2">.</span><span class="s1">server </span><span class="s0">import </span><span class="s1">HTTPResponse</span>
<span class="s0">from </span><span class="s1">websockets</span><span class="s2">.</span><span class="s1">server </span><span class="s0">import </span><span class="s1">WebSocketServerProtocol</span>
<span class="s0">from </span><span class="s1">websockets</span><span class="s2">.</span><span class="s1">typing </span><span class="s0">import </span><span class="s1">Subprotocol</span>

<span class="s0">from </span><span class="s1">uvicorn</span><span class="s2">.</span><span class="s1">_types </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">ASGI3Application</span><span class="s2">,</span>
    <span class="s1">ASGISendEvent</span><span class="s2">,</span>
    <span class="s1">WebSocketAcceptEvent</span><span class="s2">,</span>
    <span class="s1">WebSocketCloseEvent</span><span class="s2">,</span>
    <span class="s1">WebSocketConnectEvent</span><span class="s2">,</span>
    <span class="s1">WebSocketDisconnectEvent</span><span class="s2">,</span>
    <span class="s1">WebSocketReceiveEvent</span><span class="s2">,</span>
    <span class="s1">WebSocketResponseBodyEvent</span><span class="s2">,</span>
    <span class="s1">WebSocketResponseStartEvent</span><span class="s2">,</span>
    <span class="s1">WebSocketScope</span><span class="s2">,</span>
    <span class="s1">WebSocketSendEvent</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">uvicorn</span><span class="s2">.</span><span class="s1">config </span><span class="s0">import </span><span class="s1">Config</span>
<span class="s0">from </span><span class="s1">uvicorn</span><span class="s2">.</span><span class="s1">logging </span><span class="s0">import </span><span class="s1">TRACE_LOG_LEVEL</span>
<span class="s0">from </span><span class="s1">uvicorn</span><span class="s2">.</span><span class="s1">protocols</span><span class="s2">.</span><span class="s1">utils </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">ClientDisconnected</span><span class="s2">,</span>
    <span class="s1">get_local_addr</span><span class="s2">,</span>
    <span class="s1">get_path_with_query_string</span><span class="s2">,</span>
    <span class="s1">get_remote_addr</span><span class="s2">,</span>
    <span class="s1">is_ssl</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">uvicorn</span><span class="s2">.</span><span class="s1">server </span><span class="s0">import </span><span class="s1">ServerState</span>


<span class="s0">class </span><span class="s1">Server</span><span class="s2">:</span>
    <span class="s1">closing </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">register</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ws</span><span class="s2">: </span><span class="s1">WebSocketServerProtocol</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">unregister</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">ws</span><span class="s2">: </span><span class="s1">WebSocketServerProtocol</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">is_serving</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">return not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">closing</span>


<span class="s0">class </span><span class="s1">WebSocketProtocol</span><span class="s2">(</span><span class="s1">WebSocketServerProtocol</span><span class="s2">):</span>
    <span class="s1">extra_headers</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]]</span>
    <span class="s1">logger</span><span class="s2">: </span><span class="s1">logging</span><span class="s2">.</span><span class="s1">Logger </span><span class="s2">| </span><span class="s1">logging</span><span class="s2">.</span><span class="s1">LoggerAdapter</span><span class="s2">[</span><span class="s1">Any</span><span class="s2">]</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">config</span><span class="s2">: </span><span class="s1">Config</span><span class="s2">,</span>
        <span class="s1">server_state</span><span class="s2">: </span><span class="s1">ServerState</span><span class="s2">,</span>
        <span class="s1">app_state</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Any</span><span class="s2">],</span>
        <span class="s1">_loop</span><span class="s2">: </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">AbstractEventLoop </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s0">if not </span><span class="s1">config</span><span class="s2">.</span><span class="s1">loaded</span><span class="s2">:</span>
            <span class="s1">config</span><span class="s2">.</span><span class="s1">load</span><span class="s2">()</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">config </span><span class="s2">= </span><span class="s1">config</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">app </span><span class="s2">= </span><span class="s1">cast</span><span class="s2">(</span><span class="s1">ASGI3Application</span><span class="s2">, </span><span class="s1">config</span><span class="s2">.</span><span class="s1">loaded_app</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">loop </span><span class="s2">= </span><span class="s1">_loop </span><span class="s0">or </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">get_event_loop</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">root_path </span><span class="s2">= </span><span class="s1">config</span><span class="s2">.</span><span class="s1">root_path</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">app_state </span><span class="s2">= </span><span class="s1">app_state</span>

        <span class="s3"># Shared server state</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">connections </span><span class="s2">= </span><span class="s1">server_state</span><span class="s2">.</span><span class="s1">connections</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tasks </span><span class="s2">= </span><span class="s1">server_state</span><span class="s2">.</span><span class="s1">tasks</span>

        <span class="s3"># Connection state</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">transport</span><span class="s2">: </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">Transport </span><span class="s2">= </span><span class="s0">None  </span><span class="s3"># type: ignore[assignment]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">server</span><span class="s2">: </span><span class="s1">tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">int</span><span class="s2">] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">client</span><span class="s2">: </span><span class="s1">tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">int</span><span class="s2">] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scheme</span><span class="s2">: </span><span class="s1">Literal</span><span class="s2">[</span><span class="s4">&quot;wss&quot;</span><span class="s2">, </span><span class="s4">&quot;ws&quot;</span><span class="s2">] = </span><span class="s0">None  </span><span class="s3"># type: ignore[assignment]</span>

        <span class="s3"># Connection events</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">: </span><span class="s1">WebSocketScope</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_started_event </span><span class="s2">= </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">Event</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_completed_event </span><span class="s2">= </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">Event</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">closed_event </span><span class="s2">= </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">Event</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">initial_response</span><span class="s2">: </span><span class="s1">HTTPResponse </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">connect_sent </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">lost_connection_before_handshake </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">accepted_subprotocol</span><span class="s2">: </span><span class="s1">Subprotocol </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">ws_server</span><span class="s2">: </span><span class="s1">Server </span><span class="s2">= </span><span class="s1">Server</span><span class="s2">()  </span><span class="s3"># type: ignore[assignment]</span>

        <span class="s1">extensions</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">ServerExtensionFactory</span><span class="s2">] = []</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">ws_per_message_deflate</span><span class="s2">:</span>
            <span class="s1">extensions</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ServerPerMessageDeflateFactory</span><span class="s2">())</span>

        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span>
            <span class="s1">ws_handler</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ws_handler</span><span class="s2">,</span>
            <span class="s1">ws_server</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">ws_server</span><span class="s2">,  </span><span class="s3"># type: ignore[arg-type]</span>
            <span class="s1">max_size</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">ws_max_size</span><span class="s2">,</span>
            <span class="s1">max_queue</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">ws_max_queue</span><span class="s2">,</span>
            <span class="s1">ping_interval</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">ws_ping_interval</span><span class="s2">,</span>
            <span class="s1">ping_timeout</span><span class="s2">=</span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">ws_ping_timeout</span><span class="s2">,</span>
            <span class="s1">extensions</span><span class="s2">=</span><span class="s1">extensions</span><span class="s2">,</span>
            <span class="s1">logger</span><span class="s2">=</span><span class="s1">logging</span><span class="s2">.</span><span class="s1">getLogger</span><span class="s2">(</span><span class="s4">&quot;uvicorn.error&quot;</span><span class="s2">),</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">server_header </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">extra_headers </span><span class="s2">= [</span>
            <span class="s2">(</span><span class="s1">name</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;latin-1&quot;</span><span class="s2">), </span><span class="s1">value</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;latin-1&quot;</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">server_state</span><span class="s2">.</span><span class="s1">default_headers</span>
        <span class="s2">]</span>

    <span class="s0">def </span><span class="s1">connection_made</span><span class="s2">(  </span><span class="s3"># type: ignore[override]</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">transport</span><span class="s2">: </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">Transport</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">connections</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">transport </span><span class="s2">= </span><span class="s1">transport</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">server </span><span class="s2">= </span><span class="s1">get_local_addr</span><span class="s2">(</span><span class="s1">transport</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">client </span><span class="s2">= </span><span class="s1">get_remote_addr</span><span class="s2">(</span><span class="s1">transport</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">scheme </span><span class="s2">= </span><span class="s4">&quot;wss&quot; </span><span class="s0">if </span><span class="s1">is_ssl</span><span class="s2">(</span><span class="s1">transport</span><span class="s2">) </span><span class="s0">else </span><span class="s4">&quot;ws&quot;</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">logger</span><span class="s2">.</span><span class="s1">isEnabledFor</span><span class="s2">(</span><span class="s1">TRACE_LOG_LEVEL</span><span class="s2">):</span>
            <span class="s1">prefix </span><span class="s2">= </span><span class="s4">&quot;%s:%d - &quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">client </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">client </span><span class="s0">else </span><span class="s4">&quot;&quot;</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">logger</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">TRACE_LOG_LEVEL</span><span class="s2">, </span><span class="s4">&quot;%sWebSocket connection made&quot;</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">)</span>

        <span class="s1">super</span><span class="s2">().</span><span class="s1">connection_made</span><span class="s2">(</span><span class="s1">transport</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">connection_lost</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">exc</span><span class="s2">: </span><span class="s1">Exception </span><span class="s2">| </span><span class="s0">None</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">connections</span><span class="s2">.</span><span class="s1">remove</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">logger</span><span class="s2">.</span><span class="s1">isEnabledFor</span><span class="s2">(</span><span class="s1">TRACE_LOG_LEVEL</span><span class="s2">):</span>
            <span class="s1">prefix </span><span class="s2">= </span><span class="s4">&quot;%s:%d - &quot; </span><span class="s2">% </span><span class="s1">self</span><span class="s2">.</span><span class="s1">client </span><span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">client </span><span class="s0">else </span><span class="s4">&quot;&quot;</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">logger</span><span class="s2">.</span><span class="s1">log</span><span class="s2">(</span><span class="s1">TRACE_LOG_LEVEL</span><span class="s2">, </span><span class="s4">&quot;%sWebSocket connection lost&quot;</span><span class="s2">, </span><span class="s1">prefix</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">lost_connection_before_handshake </span><span class="s2">= </span><span class="s0">not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_completed_event</span><span class="s2">.</span><span class="s1">is_set</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_completed_event</span><span class="s2">.</span><span class="s1">set</span><span class="s2">()</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">connection_lost</span><span class="s2">(</span><span class="s1">exc</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">exc </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">transport</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">shutdown</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">ws_server</span><span class="s2">.</span><span class="s1">closing </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_completed_event</span><span class="s2">.</span><span class="s1">is_set</span><span class="s2">():</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">fail_connection</span><span class="s2">(</span><span class="s5">1012</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">send_500_response</span><span class="s2">()</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">transport</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">on_task_complete</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">task</span><span class="s2">: </span><span class="s1">asyncio</span><span class="s2">.</span><span class="s1">Task</span><span class="s2">[</span><span class="s0">None</span><span class="s2">]) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tasks</span><span class="s2">.</span><span class="s1">discard</span><span class="s2">(</span><span class="s1">task</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">process_request</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">request_headers</span><span class="s2">: </span><span class="s1">Headers</span><span class="s2">) </span><span class="s1">-&gt; HTTPResponse </span><span class="s2">| </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s6">&quot;&quot;&quot; 
        This hook is called to determine if the websocket should return 
        an HTTP response and close. 
 
        Our behavior here is to start the ASGI application, and then wait 
        for either `accept` or `close` in order to determine if we should 
        close the connection. 
        &quot;&quot;&quot;</span>
        <span class="s1">path_portion</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">query_string </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">partition</span><span class="s2">(</span><span class="s4">&quot;?&quot;</span><span class="s2">)</span>

        <span class="s1">websockets</span><span class="s2">.</span><span class="s1">legacy</span><span class="s2">.</span><span class="s1">handshake</span><span class="s2">.</span><span class="s1">check_request</span><span class="s2">(</span><span class="s1">request_headers</span><span class="s2">)</span>

        <span class="s1">subprotocols</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] = []</span>
        <span class="s0">for </span><span class="s1">header </span><span class="s0">in </span><span class="s1">request_headers</span><span class="s2">.</span><span class="s1">get_all</span><span class="s2">(</span><span class="s4">&quot;Sec-WebSocket-Protocol&quot;</span><span class="s2">):</span>
            <span class="s1">subprotocols</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">([</span><span class="s1">token</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">() </span><span class="s0">for </span><span class="s1">token </span><span class="s0">in </span><span class="s1">header</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s4">&quot;,&quot;</span><span class="s2">)])</span>

        <span class="s1">asgi_headers </span><span class="s2">= [</span>
            <span class="s2">(</span><span class="s1">name</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;ascii&quot;</span><span class="s2">), </span><span class="s1">value</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;ascii&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s4">&quot;surrogateescape&quot;</span><span class="s2">))</span>
            <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">request_headers</span><span class="s2">.</span><span class="s1">raw_items</span><span class="s2">()</span>
        <span class="s2">]</span>
        <span class="s1">path </span><span class="s2">= </span><span class="s1">unquote</span><span class="s2">(</span><span class="s1">path_portion</span><span class="s2">)</span>
        <span class="s1">full_path </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root_path </span><span class="s2">+ </span><span class="s1">path</span>
        <span class="s1">full_raw_path </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root_path</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;ascii&quot;</span><span class="s2">) + </span><span class="s1">path_portion</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;ascii&quot;</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">scope </span><span class="s2">= {</span>
            <span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;websocket&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;asgi&quot;</span><span class="s2">: {</span><span class="s4">&quot;version&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">config</span><span class="s2">.</span><span class="s1">asgi_version</span><span class="s2">, </span><span class="s4">&quot;spec_version&quot;</span><span class="s2">: </span><span class="s4">&quot;2.4&quot;</span><span class="s2">},</span>
            <span class="s4">&quot;http_version&quot;</span><span class="s2">: </span><span class="s4">&quot;1.1&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;scheme&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">scheme</span><span class="s2">,</span>
            <span class="s4">&quot;server&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">server</span><span class="s2">,</span>
            <span class="s4">&quot;client&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">client</span><span class="s2">,</span>
            <span class="s4">&quot;root_path&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">root_path</span><span class="s2">,</span>
            <span class="s4">&quot;path&quot;</span><span class="s2">: </span><span class="s1">full_path</span><span class="s2">,</span>
            <span class="s4">&quot;raw_path&quot;</span><span class="s2">: </span><span class="s1">full_raw_path</span><span class="s2">,</span>
            <span class="s4">&quot;query_string&quot;</span><span class="s2">: </span><span class="s1">query_string</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;ascii&quot;</span><span class="s2">),</span>
            <span class="s4">&quot;headers&quot;</span><span class="s2">: </span><span class="s1">asgi_headers</span><span class="s2">,</span>
            <span class="s4">&quot;subprotocols&quot;</span><span class="s2">: </span><span class="s1">subprotocols</span><span class="s2">,</span>
            <span class="s4">&quot;state&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">app_state</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(),</span>
            <span class="s4">&quot;extensions&quot;</span><span class="s2">: {</span><span class="s4">&quot;websocket.http.response&quot;</span><span class="s2">: {}},</span>
        <span class="s2">}</span>
        <span class="s1">task </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">loop</span><span class="s2">.</span><span class="s1">create_task</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">run_asgi</span><span class="s2">())</span>
        <span class="s1">task</span><span class="s2">.</span><span class="s1">add_done_callback</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_task_complete</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tasks</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">task</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_started_event</span><span class="s2">.</span><span class="s1">wait</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">initial_response</span>

    <span class="s0">def </span><span class="s1">process_subprotocol</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">, </span><span class="s1">headers</span><span class="s2">: </span><span class="s1">Headers</span><span class="s2">, </span><span class="s1">available_subprotocols</span><span class="s2">: </span><span class="s1">Sequence</span><span class="s2">[</span><span class="s1">Subprotocol</span><span class="s2">] | </span><span class="s0">None</span>
    <span class="s2">) </span><span class="s1">-&gt; Subprotocol </span><span class="s2">| </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s6">&quot;&quot;&quot; 
        We override the standard 'process_subprotocol' behavior here so that 
        we return whatever subprotocol is sent in the 'accept' message. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">accepted_subprotocol</span>

    <span class="s0">def </span><span class="s1">send_500_response</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s7">b&quot;Internal Server Error&quot;</span>
        <span class="s1">content </span><span class="s2">= [</span>
            <span class="s7">b&quot;HTTP/1.1 500 Internal Server Error</span><span class="s0">\r\n</span><span class="s7">&quot; b&quot;content-type: text/plain; charset=utf-8</span><span class="s0">\r\n</span><span class="s7">&quot;</span><span class="s2">,</span>
            <span class="s7">b&quot;content-length: &quot; </span><span class="s2">+ </span><span class="s1">str</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">msg</span><span class="s2">)).</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">&quot;ascii&quot;</span><span class="s2">) + </span><span class="s7">b&quot;</span><span class="s0">\r\n</span><span class="s7">&quot;</span><span class="s2">,</span>
            <span class="s7">b&quot;connection: close</span><span class="s0">\r\n</span><span class="s7">&quot;</span><span class="s2">,</span>
            <span class="s7">b&quot;</span><span class="s0">\r\n</span><span class="s7">&quot;</span><span class="s2">,</span>
            <span class="s1">msg</span><span class="s2">,</span>
        <span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">transport</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s7">b&quot;&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">content</span><span class="s2">))</span>
        <span class="s3"># Allow handler task to terminate cleanly, as websockets doesn't cancel it by</span>
        <span class="s3"># itself (see https://github.com/encode/uvicorn/issues/920)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_started_event</span><span class="s2">.</span><span class="s1">set</span><span class="s2">()</span>

    <span class="s0">async def </span><span class="s1">ws_handler</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">protocol</span><span class="s2">: </span><span class="s1">WebSocketServerProtocol</span><span class="s2">, </span><span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; Any</span><span class="s2">:  </span><span class="s3"># type: ignore[override]</span>
        <span class="s6">&quot;&quot;&quot; 
        This is the main handler function for the 'websockets' implementation 
        to call into. We just wait for close then return, and instead allow 
        'send' and 'receive' events to drive the flow. 
        &quot;&quot;&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_completed_event</span><span class="s2">.</span><span class="s1">set</span><span class="s2">()</span>
        <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">wait_closed</span><span class="s2">()</span>

    <span class="s0">async def </span><span class="s1">run_asgi</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s6">&quot;&quot;&quot; 
        Wrapper around the ASGI callable, handling exceptions and unexpected 
        termination states. 
        &quot;&quot;&quot;</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">asgi_receive</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">asgi_send</span><span class="s2">)  </span><span class="s3"># type: ignore[func-returns-value]</span>
        <span class="s0">except </span><span class="s1">ClientDisconnected</span><span class="s2">:  </span><span class="s3"># pragma: full coverage</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">closed_event</span><span class="s2">.</span><span class="s1">set</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">transport</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s0">except </span><span class="s1">BaseException</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">closed_event</span><span class="s2">.</span><span class="s1">set</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">logger</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">(</span><span class="s4">&quot;Exception in ASGI application</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_started_event</span><span class="s2">.</span><span class="s1">is_set</span><span class="s2">():</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">send_500_response</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_completed_event</span><span class="s2">.</span><span class="s1">wait</span><span class="s2">()</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">transport</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">closed_event</span><span class="s2">.</span><span class="s1">set</span><span class="s2">()</span>
            <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_started_event</span><span class="s2">.</span><span class="s1">is_set</span><span class="s2">():</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">logger</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">&quot;ASGI callable returned without sending handshake.&quot;</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">send_500_response</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">transport</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
            <span class="s0">elif </span><span class="s1">result </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">logger</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">&quot;ASGI callable should return None, but returned '%s'.&quot;</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>
                <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_completed_event</span><span class="s2">.</span><span class="s1">wait</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">transport</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s0">async def </span><span class="s1">asgi_send</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">message</span><span class="s2">: </span><span class="s1">ASGISendEvent</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">message_type </span><span class="s2">= </span><span class="s1">message</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">]</span>

        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_started_event</span><span class="s2">.</span><span class="s1">is_set</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">message_type </span><span class="s2">== </span><span class="s4">&quot;websocket.accept&quot;</span><span class="s2">:</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s1">cast</span><span class="s2">(</span><span class="s4">&quot;WebSocketAcceptEvent&quot;</span><span class="s2">, </span><span class="s1">message</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span>
                    <span class="s4">'%s - &quot;WebSocket %s&quot; [accepted]'</span><span class="s2">,</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;client&quot;</span><span class="s2">],</span>
                    <span class="s1">get_path_with_query_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">),</span>
                <span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">initial_response </span><span class="s2">= </span><span class="s0">None</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">accepted_subprotocol </span><span class="s2">= </span><span class="s1">cast</span><span class="s2">(</span><span class="s1">Optional</span><span class="s2">[</span><span class="s1">Subprotocol</span><span class="s2">], </span><span class="s1">message</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;subprotocol&quot;</span><span class="s2">))</span>
                <span class="s0">if </span><span class="s4">&quot;headers&quot; </span><span class="s0">in </span><span class="s1">message</span><span class="s2">:</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">extra_headers</span><span class="s2">.</span><span class="s1">extend</span><span class="s2">(</span>
                        <span class="s3"># ASGI spec requires bytes</span>
                        <span class="s3"># But for compatibility we need to convert it to strings</span>
                        <span class="s2">(</span><span class="s1">name</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;latin-1&quot;</span><span class="s2">), </span><span class="s1">value</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;latin-1&quot;</span><span class="s2">))</span>
                        <span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">message</span><span class="s2">[</span><span class="s4">&quot;headers&quot;</span><span class="s2">]</span>
                    <span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_started_event</span><span class="s2">.</span><span class="s1">set</span><span class="s2">()</span>

            <span class="s0">elif </span><span class="s1">message_type </span><span class="s2">== </span><span class="s4">&quot;websocket.close&quot;</span><span class="s2">:</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s1">cast</span><span class="s2">(</span><span class="s4">&quot;WebSocketCloseEvent&quot;</span><span class="s2">, </span><span class="s1">message</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span>
                    <span class="s4">'%s - &quot;WebSocket %s&quot; 403'</span><span class="s2">,</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;client&quot;</span><span class="s2">],</span>
                    <span class="s1">get_path_with_query_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">),</span>
                <span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">initial_response </span><span class="s2">= (</span><span class="s1">http</span><span class="s2">.</span><span class="s1">HTTPStatus</span><span class="s2">.</span><span class="s1">FORBIDDEN</span><span class="s2">, [], </span><span class="s7">b&quot;&quot;</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_started_event</span><span class="s2">.</span><span class="s1">set</span><span class="s2">()</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">closed_event</span><span class="s2">.</span><span class="s1">set</span><span class="s2">()</span>

            <span class="s0">elif </span><span class="s1">message_type </span><span class="s2">== </span><span class="s4">&quot;websocket.http.response.start&quot;</span><span class="s2">:</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s1">cast</span><span class="s2">(</span><span class="s4">&quot;WebSocketResponseStartEvent&quot;</span><span class="s2">, </span><span class="s1">message</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">logger</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span>
                    <span class="s4">'%s - &quot;WebSocket %s&quot; %d'</span><span class="s2">,</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;client&quot;</span><span class="s2">],</span>
                    <span class="s1">get_path_with_query_string</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">scope</span><span class="s2">),</span>
                    <span class="s1">message</span><span class="s2">[</span><span class="s4">&quot;status&quot;</span><span class="s2">],</span>
                <span class="s2">)</span>
                <span class="s3"># websockets requires the status to be an enum. look it up.</span>
                <span class="s1">status </span><span class="s2">= </span><span class="s1">http</span><span class="s2">.</span><span class="s1">HTTPStatus</span><span class="s2">(</span><span class="s1">message</span><span class="s2">[</span><span class="s4">&quot;status&quot;</span><span class="s2">])</span>
                <span class="s1">headers </span><span class="s2">= [</span>
                    <span class="s2">(</span><span class="s1">name</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;latin-1&quot;</span><span class="s2">), </span><span class="s1">value</span><span class="s2">.</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">&quot;latin-1&quot;</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">message</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;headers&quot;</span><span class="s2">, [])</span>
                <span class="s2">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">initial_response </span><span class="s2">= (</span><span class="s1">status</span><span class="s2">, </span><span class="s1">headers</span><span class="s2">, </span><span class="s7">b&quot;&quot;</span><span class="s2">)</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_started_event</span><span class="s2">.</span><span class="s1">set</span><span class="s2">()</span>

            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">msg </span><span class="s2">= (</span>
                    <span class="s4">&quot;Expected ASGI message 'websocket.accept', 'websocket.close', &quot;</span>
                    <span class="s4">&quot;or 'websocket.http.response.start' but got '%s'.&quot;</span>
                <span class="s2">)</span>
                <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s1">msg </span><span class="s2">% </span><span class="s1">message_type</span><span class="s2">)</span>

        <span class="s0">elif not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">closed_event</span><span class="s2">.</span><span class="s1">is_set</span><span class="s2">() </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">initial_response </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_completed_event</span><span class="s2">.</span><span class="s1">wait</span><span class="s2">()</span>

            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">message_type </span><span class="s2">== </span><span class="s4">&quot;websocket.send&quot;</span><span class="s2">:</span>
                    <span class="s1">message </span><span class="s2">= </span><span class="s1">cast</span><span class="s2">(</span><span class="s4">&quot;WebSocketSendEvent&quot;</span><span class="s2">, </span><span class="s1">message</span><span class="s2">)</span>
                    <span class="s1">bytes_data </span><span class="s2">= </span><span class="s1">message</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;bytes&quot;</span><span class="s2">)</span>
                    <span class="s1">text_data </span><span class="s2">= </span><span class="s1">message</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;text&quot;</span><span class="s2">)</span>
                    <span class="s1">data </span><span class="s2">= </span><span class="s1">text_data </span><span class="s0">if </span><span class="s1">bytes_data </span><span class="s0">is None else </span><span class="s1">bytes_data</span>
                    <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">send</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)  </span><span class="s3"># type: ignore[arg-type]</span>

                <span class="s0">elif </span><span class="s1">message_type </span><span class="s2">== </span><span class="s4">&quot;websocket.close&quot;</span><span class="s2">:</span>
                    <span class="s1">message </span><span class="s2">= </span><span class="s1">cast</span><span class="s2">(</span><span class="s4">&quot;WebSocketCloseEvent&quot;</span><span class="s2">, </span><span class="s1">message</span><span class="s2">)</span>
                    <span class="s1">code </span><span class="s2">= </span><span class="s1">message</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;code&quot;</span><span class="s2">, </span><span class="s5">1000</span><span class="s2">)</span>
                    <span class="s1">reason </span><span class="s2">= </span><span class="s1">message</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;reason&quot;</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">) </span><span class="s0">or </span><span class="s4">&quot;&quot;</span>
                    <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">close</span><span class="s2">(</span><span class="s1">code</span><span class="s2">, </span><span class="s1">reason</span><span class="s2">)</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">closed_event</span><span class="s2">.</span><span class="s1">set</span><span class="s2">()</span>

                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Expected ASGI message 'websocket.send' or 'websocket.close',&quot; &quot; but got '%s'.&quot;</span>
                    <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s1">msg </span><span class="s2">% </span><span class="s1">message_type</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">ConnectionClosed </span><span class="s0">as </span><span class="s1">exc</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">ClientDisconnected </span><span class="s0">from </span><span class="s1">exc</span>

        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">initial_response </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">message_type </span><span class="s2">== </span><span class="s4">&quot;websocket.http.response.body&quot;</span><span class="s2">:</span>
                <span class="s1">message </span><span class="s2">= </span><span class="s1">cast</span><span class="s2">(</span><span class="s4">&quot;WebSocketResponseBodyEvent&quot;</span><span class="s2">, </span><span class="s1">message</span><span class="s2">)</span>
                <span class="s1">body </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">initial_response</span><span class="s2">[</span><span class="s5">2</span><span class="s2">] + </span><span class="s1">message</span><span class="s2">[</span><span class="s4">&quot;body&quot;</span><span class="s2">]</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">initial_response </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">initial_response</span><span class="s2">[:</span><span class="s5">2</span><span class="s2">] + (</span><span class="s1">body</span><span class="s2">,)</span>
                <span class="s0">if not </span><span class="s1">message</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;more_body&quot;</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
                    <span class="s1">self</span><span class="s2">.</span><span class="s1">closed_event</span><span class="s2">.</span><span class="s1">set</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Expected ASGI message 'websocket.http.response.body' &quot; &quot;but got '%s'.&quot;</span>
                <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s1">msg </span><span class="s2">% </span><span class="s1">message_type</span><span class="s2">)</span>

        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s4">&quot;Unexpected ASGI message '%s', after sending 'websocket.close' &quot; &quot;or response already completed.&quot;</span>
            <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s1">msg </span><span class="s2">% </span><span class="s1">message_type</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">asgi_receive</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; WebSocketDisconnectEvent </span><span class="s2">| </span><span class="s1">WebSocketConnectEvent </span><span class="s2">| </span><span class="s1">WebSocketReceiveEvent</span><span class="s2">:</span>
        <span class="s0">if not </span><span class="s1">self</span><span class="s2">.</span><span class="s1">connect_sent</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">connect_sent </span><span class="s2">= </span><span class="s0">True</span>
            <span class="s0">return </span><span class="s2">{</span><span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;websocket.connect&quot;</span><span class="s2">}</span>

        <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handshake_completed_event</span><span class="s2">.</span><span class="s1">wait</span><span class="s2">()</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lost_connection_before_handshake</span><span class="s2">:</span>
            <span class="s3"># If the handshake failed or the app closed before handshake completion,</span>
            <span class="s3"># use 1006 Abnormal Closure.</span>
            <span class="s0">return </span><span class="s2">{</span><span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;websocket.disconnect&quot;</span><span class="s2">, </span><span class="s4">&quot;code&quot;</span><span class="s2">: </span><span class="s5">1006</span><span class="s2">}</span>

        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">closed_event</span><span class="s2">.</span><span class="s1">is_set</span><span class="s2">():</span>
            <span class="s0">return </span><span class="s2">{</span><span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;websocket.disconnect&quot;</span><span class="s2">, </span><span class="s4">&quot;code&quot;</span><span class="s2">: </span><span class="s5">1005</span><span class="s2">}</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recv</span><span class="s2">()</span>
        <span class="s0">except </span><span class="s1">ConnectionClosed</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">closed_event</span><span class="s2">.</span><span class="s1">set</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">ws_server</span><span class="s2">.</span><span class="s1">closing</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s2">{</span><span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;websocket.disconnect&quot;</span><span class="s2">, </span><span class="s4">&quot;code&quot;</span><span class="s2">: </span><span class="s5">1012</span><span class="s2">}</span>
            <span class="s0">return </span><span class="s2">{</span><span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;websocket.disconnect&quot;</span><span class="s2">, </span><span class="s4">&quot;code&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">close_code </span><span class="s0">or </span><span class="s5">1005</span><span class="s2">, </span><span class="s4">&quot;reason&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">close_reason</span><span class="s2">}</span>

        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s2">{</span><span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;websocket.receive&quot;</span><span class="s2">, </span><span class="s4">&quot;text&quot;</span><span class="s2">: </span><span class="s1">data</span><span class="s2">}</span>
        <span class="s0">return </span><span class="s2">{</span><span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;websocket.receive&quot;</span><span class="s2">, </span><span class="s4">&quot;bytes&quot;</span><span class="s2">: </span><span class="s1">data</span><span class="s2">}</span>
</pre>
</body>
</html>