<html>
<head>
<title>routing.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #5f826b; font-style: italic;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
routing.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">contextlib</span>
<span class="s0">import </span><span class="s1">functools</span>
<span class="s0">import </span><span class="s1">inspect</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">traceback</span>
<span class="s0">import </span><span class="s1">types</span>
<span class="s0">import </span><span class="s1">typing</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">contextlib </span><span class="s0">import </span><span class="s1">asynccontextmanager</span>
<span class="s0">from </span><span class="s1">enum </span><span class="s0">import </span><span class="s1">Enum</span>

<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">_exception_handler </span><span class="s0">import </span><span class="s1">wrap_app_handling_exceptions</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">_utils </span><span class="s0">import </span><span class="s1">get_route_path</span><span class="s2">, </span><span class="s1">is_async_callable</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">concurrency </span><span class="s0">import </span><span class="s1">run_in_threadpool</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">convertors </span><span class="s0">import </span><span class="s1">CONVERTOR_TYPES</span><span class="s2">, </span><span class="s1">Convertor</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">datastructures </span><span class="s0">import </span><span class="s1">URL</span><span class="s2">, </span><span class="s1">Headers</span><span class="s2">, </span><span class="s1">URLPath</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">exceptions </span><span class="s0">import </span><span class="s1">HTTPException</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">middleware </span><span class="s0">import </span><span class="s1">Middleware</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">requests </span><span class="s0">import </span><span class="s1">Request</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">responses </span><span class="s0">import </span><span class="s1">PlainTextResponse</span><span class="s2">, </span><span class="s1">RedirectResponse</span><span class="s2">, </span><span class="s1">Response</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">types </span><span class="s0">import </span><span class="s1">ASGIApp</span><span class="s2">, </span><span class="s1">Lifespan</span><span class="s2">, </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">Send</span>
<span class="s0">from </span><span class="s1">starlette</span><span class="s2">.</span><span class="s1">websockets </span><span class="s0">import </span><span class="s1">WebSocket</span><span class="s2">, </span><span class="s1">WebSocketClose</span>


<span class="s0">class </span><span class="s1">NoMatchFound</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
    <span class="s3">&quot;&quot;&quot; 
    Raised by `.url_for(name, **path_params)` and `.url_path_for(name, **path_params)` 
    if no matching route exists. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">path_params</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">params </span><span class="s2">= </span><span class="s4">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s1">path_params</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()))</span>
        <span class="s1">super</span><span class="s2">().</span><span class="s1">__init__</span><span class="s2">(</span><span class="s4">f'No route exists for name &quot;</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s4">&quot; and params &quot;</span><span class="s0">{</span><span class="s1">params</span><span class="s0">}</span><span class="s4">&quot;.'</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Match</span><span class="s2">(</span><span class="s1">Enum</span><span class="s2">):</span>
    <span class="s1">NONE </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">PARTIAL </span><span class="s2">= </span><span class="s5">1</span>
    <span class="s1">FULL </span><span class="s2">= </span><span class="s5">2</span>


<span class="s0">def </span><span class="s1">iscoroutinefunction_or_partial</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:  </span><span class="s6"># pragma: no cover</span>
    <span class="s3">&quot;&quot;&quot; 
    Correctly determines if an object is a coroutine function, 
    including those wrapped in functools.partial objects. 
    &quot;&quot;&quot;</span>
    <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
        <span class="s4">&quot;iscoroutinefunction_or_partial is deprecated, and will be removed in a future release.&quot;</span><span class="s2">,</span>
        <span class="s1">DeprecationWarning</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">while </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">functools</span><span class="s2">.</span><span class="s1">partial</span><span class="s2">):</span>
        <span class="s1">obj </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">func</span>
    <span class="s0">return </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">iscoroutinefunction</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">request_response</span><span class="s2">(</span>
    <span class="s1">func</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">[[</span><span class="s1">Request</span><span class="s2">], </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Awaitable</span><span class="s2">[</span><span class="s1">Response</span><span class="s2">] | </span><span class="s1">Response</span><span class="s2">],</span>
<span class="s2">) </span><span class="s1">-&gt; ASGIApp</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot; 
    Takes a function or coroutine `func(request) -&gt; response`, 
    and returns an ASGI application. 
    &quot;&quot;&quot;</span>
    <span class="s1">f</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">[[</span><span class="s1">Request</span><span class="s2">], </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Awaitable</span><span class="s2">[</span><span class="s1">Response</span><span class="s2">]] = (</span>
        <span class="s1">func </span><span class="s0">if </span><span class="s1">is_async_callable</span><span class="s2">(</span><span class="s1">func</span><span class="s2">) </span><span class="s0">else </span><span class="s1">functools</span><span class="s2">.</span><span class="s1">partial</span><span class="s2">(</span><span class="s1">run_in_threadpool</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)  </span><span class="s6"># type:ignore</span>
    <span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">app</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">request </span><span class="s2">= </span><span class="s1">Request</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>

        <span class="s0">async def </span><span class="s1">app</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
            <span class="s1">response </span><span class="s2">= </span><span class="s0">await </span><span class="s1">f</span><span class="s2">(</span><span class="s1">request</span><span class="s2">)</span>
            <span class="s0">await </span><span class="s1">response</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>

        <span class="s0">await </span><span class="s1">wrap_app_handling_exceptions</span><span class="s2">(</span><span class="s1">app</span><span class="s2">, </span><span class="s1">request</span><span class="s2">)(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">app</span>


<span class="s0">def </span><span class="s1">websocket_session</span><span class="s2">(</span>
    <span class="s1">func</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">[[</span><span class="s1">WebSocket</span><span class="s2">], </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Awaitable</span><span class="s2">[</span><span class="s0">None</span><span class="s2">]],</span>
<span class="s2">) </span><span class="s1">-&gt; ASGIApp</span><span class="s2">:</span>
    <span class="s3">&quot;&quot;&quot; 
    Takes a coroutine `func(session)`, and returns an ASGI application. 
    &quot;&quot;&quot;</span>
    <span class="s6"># assert asyncio.iscoroutinefunction(func), &quot;WebSocket endpoints must be async&quot;</span>

    <span class="s0">async def </span><span class="s1">app</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">session </span><span class="s2">= </span><span class="s1">WebSocket</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">=</span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">=</span><span class="s1">send</span><span class="s2">)</span>

        <span class="s0">async def </span><span class="s1">app</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">func</span><span class="s2">(</span><span class="s1">session</span><span class="s2">)</span>

        <span class="s0">await </span><span class="s1">wrap_app_handling_exceptions</span><span class="s2">(</span><span class="s1">app</span><span class="s2">, </span><span class="s1">session</span><span class="s2">)(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">app</span>


<span class="s0">def </span><span class="s1">get_name</span><span class="s2">(</span><span class="s1">endpoint</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">[..., </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
    <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">endpoint</span><span class="s2">, </span><span class="s4">&quot;__name__&quot;</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">replace_params</span><span class="s2">(</span>
    <span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">param_convertors</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Convertor</span><span class="s2">[</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]],</span>
    <span class="s1">path_params</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">],</span>
<span class="s2">) </span><span class="s1">-&gt; tuple</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">str</span><span class="s2">]]:</span>
    <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">path_params</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
        <span class="s0">if </span><span class="s4">&quot;{&quot; </span><span class="s2">+ </span><span class="s1">key </span><span class="s2">+ </span><span class="s4">&quot;}&quot; </span><span class="s0">in </span><span class="s1">path</span><span class="s2">:</span>
            <span class="s1">convertor </span><span class="s2">= </span><span class="s1">param_convertors</span><span class="s2">[</span><span class="s1">key</span><span class="s2">]</span>
            <span class="s1">value </span><span class="s2">= </span><span class="s1">convertor</span><span class="s2">.</span><span class="s1">to_string</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">replace</span><span class="s2">(</span><span class="s4">&quot;{&quot; </span><span class="s2">+ </span><span class="s1">key </span><span class="s2">+ </span><span class="s4">&quot;}&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">)</span>
            <span class="s1">path_params</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">key</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">path</span><span class="s2">, </span><span class="s1">path_params</span>


<span class="s6"># Match parameters in URL paths, eg. '{param}', and '{param:int}'</span>
<span class="s1">PARAM_REGEX </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s4">&quot;{([a-zA-Z_][a-zA-Z0-9_]*)(:[a-zA-Z_][a-zA-Z0-9_]*)?}&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">compile_path</span><span class="s2">(</span>
    <span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
<span class="s2">) </span><span class="s1">-&gt; tuple</span><span class="s2">[</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Pattern</span><span class="s2">[</span><span class="s1">str</span><span class="s2">], </span><span class="s1">str</span><span class="s2">, </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">Convertor</span><span class="s2">[</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]]]:</span>
    <span class="s3">&quot;&quot;&quot; 
    Given a path string, like: &quot;/{username:str}&quot;, 
    or a host string, like: &quot;{subdomain}.mydomain.org&quot;, return a three-tuple 
    of (regex, format, {param_name:convertor}). 
 
    regex:      &quot;/(?P&lt;username&gt;[^/]+)&quot; 
    format:     &quot;/{username}&quot; 
    convertors: {&quot;username&quot;: StringConvertor()} 
    &quot;&quot;&quot;</span>
    <span class="s1">is_host </span><span class="s2">= </span><span class="s0">not </span><span class="s1">path</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;/&quot;</span><span class="s2">)</span>

    <span class="s1">path_regex </span><span class="s2">= </span><span class="s4">&quot;^&quot;</span>
    <span class="s1">path_format </span><span class="s2">= </span><span class="s4">&quot;&quot;</span>
    <span class="s1">duplicated_params </span><span class="s2">= </span><span class="s1">set</span><span class="s2">()</span>

    <span class="s1">idx </span><span class="s2">= </span><span class="s5">0</span>
    <span class="s1">param_convertors </span><span class="s2">= {}</span>
    <span class="s0">for </span><span class="s1">match </span><span class="s0">in </span><span class="s1">PARAM_REGEX</span><span class="s2">.</span><span class="s1">finditer</span><span class="s2">(</span><span class="s1">path</span><span class="s2">):</span>
        <span class="s1">param_name</span><span class="s2">, </span><span class="s1">convertor_type </span><span class="s2">= </span><span class="s1">match</span><span class="s2">.</span><span class="s1">groups</span><span class="s2">(</span><span class="s4">&quot;str&quot;</span><span class="s2">)</span>
        <span class="s1">convertor_type </span><span class="s2">= </span><span class="s1">convertor_type</span><span class="s2">.</span><span class="s1">lstrip</span><span class="s2">(</span><span class="s4">&quot;:&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">convertor_type </span><span class="s0">in </span><span class="s1">CONVERTOR_TYPES</span><span class="s2">, </span><span class="s4">f&quot;Unknown path convertor '</span><span class="s0">{</span><span class="s1">convertor_type</span><span class="s0">}</span><span class="s4">'&quot;</span>
        <span class="s1">convertor </span><span class="s2">= </span><span class="s1">CONVERTOR_TYPES</span><span class="s2">[</span><span class="s1">convertor_type</span><span class="s2">]</span>

        <span class="s1">path_regex </span><span class="s2">+= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">path</span><span class="s2">[</span><span class="s1">idx </span><span class="s2">: </span><span class="s1">match</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()])</span>
        <span class="s1">path_regex </span><span class="s2">+= </span><span class="s4">f&quot;(?P&lt;</span><span class="s0">{</span><span class="s1">param_name</span><span class="s0">}</span><span class="s4">&gt;</span><span class="s0">{</span><span class="s1">convertor</span><span class="s2">.</span><span class="s1">regex</span><span class="s0">}</span><span class="s4">)&quot;</span>

        <span class="s1">path_format </span><span class="s2">+= </span><span class="s1">path</span><span class="s2">[</span><span class="s1">idx </span><span class="s2">: </span><span class="s1">match</span><span class="s2">.</span><span class="s1">start</span><span class="s2">()]</span>
        <span class="s1">path_format </span><span class="s2">+= </span><span class="s4">&quot;{%s}&quot; </span><span class="s2">% </span><span class="s1">param_name</span>

        <span class="s0">if </span><span class="s1">param_name </span><span class="s0">in </span><span class="s1">param_convertors</span><span class="s2">:</span>
            <span class="s1">duplicated_params</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">param_name</span><span class="s2">)</span>

        <span class="s1">param_convertors</span><span class="s2">[</span><span class="s1">param_name</span><span class="s2">] = </span><span class="s1">convertor</span>

        <span class="s1">idx </span><span class="s2">= </span><span class="s1">match</span><span class="s2">.</span><span class="s1">end</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">duplicated_params</span><span class="s2">:</span>
        <span class="s1">names </span><span class="s2">= </span><span class="s4">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">duplicated_params</span><span class="s2">))</span>
        <span class="s1">ending </span><span class="s2">= </span><span class="s4">&quot;s&quot; </span><span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">duplicated_params</span><span class="s2">) &gt; </span><span class="s5">1 </span><span class="s0">else </span><span class="s4">&quot;&quot;</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s4">f&quot;Duplicated param name</span><span class="s0">{</span><span class="s1">ending</span><span class="s0">} {</span><span class="s1">names</span><span class="s0">} </span><span class="s4">at path </span><span class="s0">{</span><span class="s1">path</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">is_host</span><span class="s2">:</span>
        <span class="s6"># Align with `Host.matches()` behavior, which ignores port.</span>
        <span class="s1">hostname </span><span class="s2">= </span><span class="s1">path</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">:].</span><span class="s1">split</span><span class="s2">(</span><span class="s4">&quot;:&quot;</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s1">path_regex </span><span class="s2">+= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">hostname</span><span class="s2">) + </span><span class="s4">&quot;$&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">path_regex </span><span class="s2">+= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">escape</span><span class="s2">(</span><span class="s1">path</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">:]) + </span><span class="s4">&quot;$&quot;</span>

    <span class="s1">path_format </span><span class="s2">+= </span><span class="s1">path</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">:]</span>

    <span class="s0">return </span><span class="s1">re</span><span class="s2">.</span><span class="s1">compile</span><span class="s2">(</span><span class="s1">path_regex</span><span class="s2">), </span><span class="s1">path_format</span><span class="s2">, </span><span class="s1">param_convertors</span>


<span class="s0">class </span><span class="s1">BaseRoute</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">matches</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">) </span><span class="s1">-&gt; tuple</span><span class="s2">[</span><span class="s1">Match</span><span class="s2">, </span><span class="s1">Scope</span><span class="s2">]:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">()  </span><span class="s6"># pragma: no cover</span>

    <span class="s0">def </span><span class="s1">url_path_for</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, /, **</span><span class="s1">path_params</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; URLPath</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">()  </span><span class="s6"># pragma: no cover</span>

    <span class="s0">async def </span><span class="s1">handle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError</span><span class="s2">()  </span><span class="s6"># pragma: no cover</span>

    <span class="s0">async def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot; 
        A route may be used in isolation as a stand-alone ASGI app. 
        This is a somewhat contrived case, as they'll almost always be used 
        within a Router, but could be useful for some tooling and minimal apps. 
        &quot;&quot;&quot;</span>
        <span class="s1">match</span><span class="s2">, </span><span class="s1">child_scope </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">matches</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">match </span><span class="s2">== </span><span class="s1">Match</span><span class="s2">.</span><span class="s1">NONE</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] == </span><span class="s4">&quot;http&quot;</span><span class="s2">:</span>
                <span class="s1">response </span><span class="s2">= </span><span class="s1">PlainTextResponse</span><span class="s2">(</span><span class="s4">&quot;Not Found&quot;</span><span class="s2">, </span><span class="s1">status_code</span><span class="s2">=</span><span class="s5">404</span><span class="s2">)</span>
                <span class="s0">await </span><span class="s1">response</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] == </span><span class="s4">&quot;websocket&quot;</span><span class="s2">:  </span><span class="s6"># pragma: no branch</span>
                <span class="s1">websocket_close </span><span class="s2">= </span><span class="s1">WebSocketClose</span><span class="s2">()</span>
                <span class="s0">await </span><span class="s1">websocket_close</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>
            <span class="s0">return</span>

        <span class="s1">scope</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">child_scope</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">handle</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">Route</span><span class="s2">(</span><span class="s1">BaseRoute</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
        <span class="s1">endpoint</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">[..., </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">],</span>
        <span class="s2">*,</span>
        <span class="s1">methods</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">include_in_schema</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
        <span class="s1">middleware</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Sequence</span><span class="s2">[</span><span class="s1">Middleware</span><span class="s2">] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">path</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;/&quot;</span><span class="s2">), </span><span class="s4">&quot;Routed paths must start with '/'&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">= </span><span class="s1">path</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">endpoint </span><span class="s2">= </span><span class="s1">endpoint</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">get_name</span><span class="s2">(</span><span class="s1">endpoint</span><span class="s2">) </span><span class="s0">if </span><span class="s1">name </span><span class="s0">is None else </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">include_in_schema </span><span class="s2">= </span><span class="s1">include_in_schema</span>

        <span class="s1">endpoint_handler </span><span class="s2">= </span><span class="s1">endpoint</span>
        <span class="s0">while </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">endpoint_handler</span><span class="s2">, </span><span class="s1">functools</span><span class="s2">.</span><span class="s1">partial</span><span class="s2">):</span>
            <span class="s1">endpoint_handler </span><span class="s2">= </span><span class="s1">endpoint_handler</span><span class="s2">.</span><span class="s1">func</span>
        <span class="s0">if </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">isfunction</span><span class="s2">(</span><span class="s1">endpoint_handler</span><span class="s2">) </span><span class="s0">or </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">ismethod</span><span class="s2">(</span><span class="s1">endpoint_handler</span><span class="s2">):</span>
            <span class="s6"># Endpoint is function or method. Treat it as `func(request) -&gt; response`.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">app </span><span class="s2">= </span><span class="s1">request_response</span><span class="s2">(</span><span class="s1">endpoint</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">methods </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s1">methods </span><span class="s2">= [</span><span class="s4">&quot;GET&quot;</span><span class="s2">]</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s6"># Endpoint is a class. Treat it as ASGI.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">app </span><span class="s2">= </span><span class="s1">endpoint</span>

        <span class="s0">if </span><span class="s1">middleware </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">cls</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">middleware</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">app </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">methods </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">methods </span><span class="s2">= </span><span class="s0">None</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">methods </span><span class="s2">= {</span><span class="s1">method</span><span class="s2">.</span><span class="s1">upper</span><span class="s2">() </span><span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s1">methods</span><span class="s2">}</span>
            <span class="s0">if </span><span class="s4">&quot;GET&quot; </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">methods</span><span class="s2">:</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">methods</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s4">&quot;HEAD&quot;</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">path_regex</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path_format</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors </span><span class="s2">= </span><span class="s1">compile_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">matches</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">) </span><span class="s1">-&gt; tuple</span><span class="s2">[</span><span class="s1">Match</span><span class="s2">, </span><span class="s1">Scope</span><span class="s2">]:</span>
        <span class="s1">path_params</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] == </span><span class="s4">&quot;http&quot;</span><span class="s2">:</span>
            <span class="s1">route_path </span><span class="s2">= </span><span class="s1">get_route_path</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">)</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path_regex</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">route_path</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">match</span><span class="s2">:</span>
                <span class="s1">matched_params </span><span class="s2">= </span><span class="s1">match</span><span class="s2">.</span><span class="s1">groupdict</span><span class="s2">()</span>
                <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">matched_params</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                    <span class="s1">matched_params</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">convert</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
                <span class="s1">path_params </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;path_params&quot;</span><span class="s2">, {}))</span>
                <span class="s1">path_params</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">matched_params</span><span class="s2">)</span>
                <span class="s1">child_scope </span><span class="s2">= {</span><span class="s4">&quot;endpoint&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">endpoint</span><span class="s2">, </span><span class="s4">&quot;path_params&quot;</span><span class="s2">: </span><span class="s1">path_params</span><span class="s2">}</span>
                <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">methods </span><span class="s0">and </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;method&quot;</span><span class="s2">] </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">methods</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">Match</span><span class="s2">.</span><span class="s1">PARTIAL</span><span class="s2">, </span><span class="s1">child_scope</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">Match</span><span class="s2">.</span><span class="s1">FULL</span><span class="s2">, </span><span class="s1">child_scope</span>
        <span class="s0">return </span><span class="s1">Match</span><span class="s2">.</span><span class="s1">NONE</span><span class="s2">, {}</span>

    <span class="s0">def </span><span class="s1">url_path_for</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, /, **</span><span class="s1">path_params</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; URLPath</span><span class="s2">:</span>
        <span class="s1">seen_params </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">path_params</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
        <span class="s1">expected_params </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>

        <span class="s0">if </span><span class="s1">name </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">or </span><span class="s1">seen_params </span><span class="s2">!= </span><span class="s1">expected_params</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NoMatchFound</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">path_params</span><span class="s2">)</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">remaining_params </span><span class="s2">= </span><span class="s1">replace_params</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path_format</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors</span><span class="s2">, </span><span class="s1">path_params</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">remaining_params</span>
        <span class="s0">return </span><span class="s1">URLPath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">=</span><span class="s1">path</span><span class="s2">, </span><span class="s1">protocol</span><span class="s2">=</span><span class="s4">&quot;http&quot;</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">handle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">methods </span><span class="s0">and </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;method&quot;</span><span class="s2">] </span><span class="s0">not in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">methods</span><span class="s2">:</span>
            <span class="s1">headers </span><span class="s2">= {</span><span class="s4">&quot;Allow&quot;</span><span class="s2">: </span><span class="s4">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">methods</span><span class="s2">)}</span>
            <span class="s0">if </span><span class="s4">&quot;app&quot; </span><span class="s0">in </span><span class="s1">scope</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">HTTPException</span><span class="s2">(</span><span class="s1">status_code</span><span class="s2">=</span><span class="s5">405</span><span class="s2">, </span><span class="s1">headers</span><span class="s2">=</span><span class="s1">headers</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">response </span><span class="s2">= </span><span class="s1">PlainTextResponse</span><span class="s2">(</span><span class="s4">&quot;Method Not Allowed&quot;</span><span class="s2">, </span><span class="s1">status_code</span><span class="s2">=</span><span class="s5">405</span><span class="s2">, </span><span class="s1">headers</span><span class="s2">=</span><span class="s1">headers</span><span class="s2">)</span>
            <span class="s0">await </span><span class="s1">response</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s2">(</span>
            <span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">Route</span><span class="s2">)</span>
            <span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">path</span>
            <span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">endpoint </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">endpoint</span>
            <span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">methods </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">methods</span>
        <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s1">class_name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
        <span class="s1">methods </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">methods </span><span class="s0">or </span><span class="s2">[])</span>
        <span class="s1">path</span><span class="s2">, </span><span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span>
        <span class="s0">return </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">class_name</span><span class="s0">}</span><span class="s4">(path=</span><span class="s0">{</span><span class="s1">path</span><span class="s0">!r}</span><span class="s4">, name=</span><span class="s0">{</span><span class="s1">name</span><span class="s0">!r}</span><span class="s4">, methods=</span><span class="s0">{</span><span class="s1">methods</span><span class="s0">!r}</span><span class="s4">)&quot;</span>


<span class="s0">class </span><span class="s1">WebSocketRoute</span><span class="s2">(</span><span class="s1">BaseRoute</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
        <span class="s1">endpoint</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">[..., </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">],</span>
        <span class="s2">*,</span>
        <span class="s1">name</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">middleware</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Sequence</span><span class="s2">[</span><span class="s1">Middleware</span><span class="s2">] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">path</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;/&quot;</span><span class="s2">), </span><span class="s4">&quot;Routed paths must start with '/'&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">= </span><span class="s1">path</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">endpoint </span><span class="s2">= </span><span class="s1">endpoint</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">get_name</span><span class="s2">(</span><span class="s1">endpoint</span><span class="s2">) </span><span class="s0">if </span><span class="s1">name </span><span class="s0">is None else </span><span class="s1">name</span>

        <span class="s1">endpoint_handler </span><span class="s2">= </span><span class="s1">endpoint</span>
        <span class="s0">while </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">endpoint_handler</span><span class="s2">, </span><span class="s1">functools</span><span class="s2">.</span><span class="s1">partial</span><span class="s2">):</span>
            <span class="s1">endpoint_handler </span><span class="s2">= </span><span class="s1">endpoint_handler</span><span class="s2">.</span><span class="s1">func</span>
        <span class="s0">if </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">isfunction</span><span class="s2">(</span><span class="s1">endpoint_handler</span><span class="s2">) </span><span class="s0">or </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">ismethod</span><span class="s2">(</span><span class="s1">endpoint_handler</span><span class="s2">):</span>
            <span class="s6"># Endpoint is function or method. Treat it as `func(websocket)`.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">app </span><span class="s2">= </span><span class="s1">websocket_session</span><span class="s2">(</span><span class="s1">endpoint</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s6"># Endpoint is a class. Treat it as ASGI.</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">app </span><span class="s2">= </span><span class="s1">endpoint</span>

        <span class="s0">if </span><span class="s1">middleware </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">cls</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">middleware</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">app </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">path_regex</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path_format</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors </span><span class="s2">= </span><span class="s1">compile_path</span><span class="s2">(</span><span class="s1">path</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">matches</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">) </span><span class="s1">-&gt; tuple</span><span class="s2">[</span><span class="s1">Match</span><span class="s2">, </span><span class="s1">Scope</span><span class="s2">]:</span>
        <span class="s1">path_params</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] == </span><span class="s4">&quot;websocket&quot;</span><span class="s2">:</span>
            <span class="s1">route_path </span><span class="s2">= </span><span class="s1">get_route_path</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">)</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path_regex</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">route_path</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">match</span><span class="s2">:</span>
                <span class="s1">matched_params </span><span class="s2">= </span><span class="s1">match</span><span class="s2">.</span><span class="s1">groupdict</span><span class="s2">()</span>
                <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">matched_params</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                    <span class="s1">matched_params</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">convert</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
                <span class="s1">path_params </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;path_params&quot;</span><span class="s2">, {}))</span>
                <span class="s1">path_params</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">matched_params</span><span class="s2">)</span>
                <span class="s1">child_scope </span><span class="s2">= {</span><span class="s4">&quot;endpoint&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">endpoint</span><span class="s2">, </span><span class="s4">&quot;path_params&quot;</span><span class="s2">: </span><span class="s1">path_params</span><span class="s2">}</span>
                <span class="s0">return </span><span class="s1">Match</span><span class="s2">.</span><span class="s1">FULL</span><span class="s2">, </span><span class="s1">child_scope</span>
        <span class="s0">return </span><span class="s1">Match</span><span class="s2">.</span><span class="s1">NONE</span><span class="s2">, {}</span>

    <span class="s0">def </span><span class="s1">url_path_for</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, /, **</span><span class="s1">path_params</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; URLPath</span><span class="s2">:</span>
        <span class="s1">seen_params </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">path_params</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>
        <span class="s1">expected_params </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">())</span>

        <span class="s0">if </span><span class="s1">name </span><span class="s2">!= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">or </span><span class="s1">seen_params </span><span class="s2">!= </span><span class="s1">expected_params</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">NoMatchFound</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">path_params</span><span class="s2">)</span>

        <span class="s1">path</span><span class="s2">, </span><span class="s1">remaining_params </span><span class="s2">= </span><span class="s1">replace_params</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path_format</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors</span><span class="s2">, </span><span class="s1">path_params</span><span class="s2">)</span>
        <span class="s0">assert not </span><span class="s1">remaining_params</span>
        <span class="s0">return </span><span class="s1">URLPath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">=</span><span class="s1">path</span><span class="s2">, </span><span class="s1">protocol</span><span class="s2">=</span><span class="s4">&quot;websocket&quot;</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">handle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">WebSocketRoute</span><span class="s2">) </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">path </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">endpoint </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">endpoint</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">}</span><span class="s4">(path=</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s0">!r}</span><span class="s4">, name=</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s0">!r}</span><span class="s4">)&quot;</span>


<span class="s0">class </span><span class="s1">Mount</span><span class="s2">(</span><span class="s1">BaseRoute</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
        <span class="s1">app</span><span class="s2">: </span><span class="s1">ASGIApp </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">routes</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Sequence</span><span class="s2">[</span><span class="s1">BaseRoute</span><span class="s2">] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">*,</span>
        <span class="s1">middleware</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Sequence</span><span class="s2">[</span><span class="s1">Middleware</span><span class="s2">] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">path </span><span class="s2">== </span><span class="s4">&quot;&quot; </span><span class="s0">or </span><span class="s1">path</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;/&quot;</span><span class="s2">), </span><span class="s4">&quot;Routed paths must start with '/'&quot;</span>
        <span class="s0">assert </span><span class="s1">app </span><span class="s0">is not None or </span><span class="s1">routes </span><span class="s0">is not None</span><span class="s2">, </span><span class="s4">&quot;Either 'app=...', or 'routes=' must be specified&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">= </span><span class="s1">path</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">(</span><span class="s4">&quot;/&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">app </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_base_app</span><span class="s2">: </span><span class="s1">ASGIApp </span><span class="s2">= </span><span class="s1">app</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">_base_app </span><span class="s2">= </span><span class="s1">Router</span><span class="s2">(</span><span class="s1">routes</span><span class="s2">=</span><span class="s1">routes</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">app </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_base_app</span>
        <span class="s0">if </span><span class="s1">middleware </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">cls</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">middleware</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">app </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">path_regex</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path_format</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors </span><span class="s2">= </span><span class="s1">compile_path</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">+ </span><span class="s4">&quot;/{path:path}&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">routes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; list</span><span class="s2">[</span><span class="s1">BaseRoute</span><span class="s2">]:</span>
        <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">_base_app</span><span class="s2">, </span><span class="s4">&quot;routes&quot;</span><span class="s2">, [])</span>

    <span class="s0">def </span><span class="s1">matches</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">) </span><span class="s1">-&gt; tuple</span><span class="s2">[</span><span class="s1">Match</span><span class="s2">, </span><span class="s1">Scope</span><span class="s2">]:</span>
        <span class="s1">path_params</span><span class="s2">: </span><span class="s1">dict</span><span class="s2">[</span><span class="s1">str</span><span class="s2">, </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;http&quot;</span><span class="s2">, </span><span class="s4">&quot;websocket&quot;</span><span class="s2">):  </span><span class="s6"># pragma: no branch</span>
            <span class="s1">root_path </span><span class="s2">= </span><span class="s1">scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;root_path&quot;</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">)</span>
            <span class="s1">route_path </span><span class="s2">= </span><span class="s1">get_route_path</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">)</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path_regex</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">route_path</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">match</span><span class="s2">:</span>
                <span class="s1">matched_params </span><span class="s2">= </span><span class="s1">match</span><span class="s2">.</span><span class="s1">groupdict</span><span class="s2">()</span>
                <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">matched_params</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                    <span class="s1">matched_params</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">convert</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
                <span class="s1">remaining_path </span><span class="s2">= </span><span class="s4">&quot;/&quot; </span><span class="s2">+ </span><span class="s1">matched_params</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;path&quot;</span><span class="s2">)</span>
                <span class="s1">matched_path </span><span class="s2">= </span><span class="s1">route_path</span><span class="s2">[: -</span><span class="s1">len</span><span class="s2">(</span><span class="s1">remaining_path</span><span class="s2">)]</span>
                <span class="s1">path_params </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;path_params&quot;</span><span class="s2">, {}))</span>
                <span class="s1">path_params</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">matched_params</span><span class="s2">)</span>
                <span class="s1">child_scope </span><span class="s2">= {</span>
                    <span class="s4">&quot;path_params&quot;</span><span class="s2">: </span><span class="s1">path_params</span><span class="s2">,</span>
                    <span class="s6"># app_root_path will only be set at the top level scope,</span>
                    <span class="s6"># initialized with the (optional) value of a root_path</span>
                    <span class="s6"># set above/before Starlette. And even though any</span>
                    <span class="s6"># mount will have its own child scope with its own respective</span>
                    <span class="s6"># root_path, the app_root_path will always be available in all</span>
                    <span class="s6"># the child scopes with the same top level value because it's</span>
                    <span class="s6"># set only once here with a default, any other child scope will</span>
                    <span class="s6"># just inherit that app_root_path default value stored in the</span>
                    <span class="s6"># scope. All this is needed to support Request.url_for(), as it</span>
                    <span class="s6"># uses the app_root_path to build the URL path.</span>
                    <span class="s4">&quot;app_root_path&quot;</span><span class="s2">: </span><span class="s1">scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;app_root_path&quot;</span><span class="s2">, </span><span class="s1">root_path</span><span class="s2">),</span>
                    <span class="s4">&quot;root_path&quot;</span><span class="s2">: </span><span class="s1">root_path </span><span class="s2">+ </span><span class="s1">matched_path</span><span class="s2">,</span>
                    <span class="s4">&quot;endpoint&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span><span class="s2">,</span>
                <span class="s2">}</span>
                <span class="s0">return </span><span class="s1">Match</span><span class="s2">.</span><span class="s1">FULL</span><span class="s2">, </span><span class="s1">child_scope</span>
        <span class="s0">return </span><span class="s1">Match</span><span class="s2">.</span><span class="s1">NONE</span><span class="s2">, {}</span>

    <span class="s0">def </span><span class="s1">url_path_for</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, /, **</span><span class="s1">path_params</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; URLPath</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">is not None and </span><span class="s1">name </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">and </span><span class="s4">&quot;path&quot; </span><span class="s0">in </span><span class="s1">path_params</span><span class="s2">:</span>
            <span class="s6"># 'name' matches &quot;&lt;mount_name&gt;&quot;.</span>
            <span class="s1">path_params</span><span class="s2">[</span><span class="s4">&quot;path&quot;</span><span class="s2">] = </span><span class="s1">path_params</span><span class="s2">[</span><span class="s4">&quot;path&quot;</span><span class="s2">].</span><span class="s1">lstrip</span><span class="s2">(</span><span class="s4">&quot;/&quot;</span><span class="s2">)</span>
            <span class="s1">path</span><span class="s2">, </span><span class="s1">remaining_params </span><span class="s2">= </span><span class="s1">replace_params</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path_format</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors</span><span class="s2">, </span><span class="s1">path_params</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">remaining_params</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">URLPath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">=</span><span class="s1">path</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">is None or </span><span class="s1">name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">+ </span><span class="s4">&quot;:&quot;</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s6"># No mount name.</span>
                <span class="s1">remaining_name </span><span class="s2">= </span><span class="s1">name</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s6"># 'name' matches &quot;&lt;mount_name&gt;:&lt;child_name&gt;&quot;.</span>
                <span class="s1">remaining_name </span><span class="s2">= </span><span class="s1">name</span><span class="s2">[</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) + </span><span class="s5">1 </span><span class="s2">:]</span>
            <span class="s1">path_kwarg </span><span class="s2">= </span><span class="s1">path_params</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;path&quot;</span><span class="s2">)</span>
            <span class="s1">path_params</span><span class="s2">[</span><span class="s4">&quot;path&quot;</span><span class="s2">] = </span><span class="s4">&quot;&quot;</span>
            <span class="s1">path_prefix</span><span class="s2">, </span><span class="s1">remaining_params </span><span class="s2">= </span><span class="s1">replace_params</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path_format</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors</span><span class="s2">, </span><span class="s1">path_params</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">path_kwarg </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">remaining_params</span><span class="s2">[</span><span class="s4">&quot;path&quot;</span><span class="s2">] = </span><span class="s1">path_kwarg</span>
            <span class="s0">for </span><span class="s1">route </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">routes </span><span class="s0">or </span><span class="s2">[]:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">url </span><span class="s2">= </span><span class="s1">route</span><span class="s2">.</span><span class="s1">url_path_for</span><span class="s2">(</span><span class="s1">remaining_name</span><span class="s2">, **</span><span class="s1">remaining_params</span><span class="s2">)</span>
                    <span class="s0">return </span><span class="s1">URLPath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">=</span><span class="s1">path_prefix</span><span class="s2">.</span><span class="s1">rstrip</span><span class="s2">(</span><span class="s4">&quot;/&quot;</span><span class="s2">) + </span><span class="s1">str</span><span class="s2">(</span><span class="s1">url</span><span class="s2">), </span><span class="s1">protocol</span><span class="s2">=</span><span class="s1">url</span><span class="s2">.</span><span class="s1">protocol</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">NoMatchFound</span><span class="s2">:</span>
                    <span class="s0">pass</span>
        <span class="s0">raise </span><span class="s1">NoMatchFound</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">path_params</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">handle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">Mount</span><span class="s2">) </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">path </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">path </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">app </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">app</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s1">class_name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">or </span><span class="s4">&quot;&quot;</span>
        <span class="s0">return </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">class_name</span><span class="s0">}</span><span class="s4">(path=</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">path</span><span class="s0">!r}</span><span class="s4">, name=</span><span class="s0">{</span><span class="s1">name</span><span class="s0">!r}</span><span class="s4">, app=</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span><span class="s0">!r}</span><span class="s4">)&quot;</span>


<span class="s0">class </span><span class="s1">Host</span><span class="s2">(</span><span class="s1">BaseRoute</span><span class="s2">):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">host</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">app</span><span class="s2">: </span><span class="s1">ASGIApp</span><span class="s2">, </span><span class="s1">name</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">assert not </span><span class="s1">host</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s4">&quot;/&quot;</span><span class="s2">), </span><span class="s4">&quot;Host must not start with '/'&quot;</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">host </span><span class="s2">= </span><span class="s1">host</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">app </span><span class="s2">= </span><span class="s1">app</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">name</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">host_regex</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host_format</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors </span><span class="s2">= </span><span class="s1">compile_path</span><span class="s2">(</span><span class="s1">host</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">property</span>
    <span class="s0">def </span><span class="s1">routes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; list</span><span class="s2">[</span><span class="s1">BaseRoute</span><span class="s2">]:</span>
        <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span><span class="s2">, </span><span class="s4">&quot;routes&quot;</span><span class="s2">, [])</span>

    <span class="s0">def </span><span class="s1">matches</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">) </span><span class="s1">-&gt; tuple</span><span class="s2">[</span><span class="s1">Match</span><span class="s2">, </span><span class="s1">Scope</span><span class="s2">]:</span>
        <span class="s0">if </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;http&quot;</span><span class="s2">, </span><span class="s4">&quot;websocket&quot;</span><span class="s2">):  </span><span class="s6"># pragma:no branch</span>
            <span class="s1">headers </span><span class="s2">= </span><span class="s1">Headers</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s1">scope</span><span class="s2">)</span>
            <span class="s1">host </span><span class="s2">= </span><span class="s1">headers</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;host&quot;</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s2">).</span><span class="s1">split</span><span class="s2">(</span><span class="s4">&quot;:&quot;</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>
            <span class="s1">match </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host_regex</span><span class="s2">.</span><span class="s1">match</span><span class="s2">(</span><span class="s1">host</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">match</span><span class="s2">:</span>
                <span class="s1">matched_params </span><span class="s2">= </span><span class="s1">match</span><span class="s2">.</span><span class="s1">groupdict</span><span class="s2">()</span>
                <span class="s0">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s0">in </span><span class="s1">matched_params</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                    <span class="s1">matched_params</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] = </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors</span><span class="s2">[</span><span class="s1">key</span><span class="s2">].</span><span class="s1">convert</span><span class="s2">(</span><span class="s1">value</span><span class="s2">)</span>
                <span class="s1">path_params </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;path_params&quot;</span><span class="s2">, {}))</span>
                <span class="s1">path_params</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">matched_params</span><span class="s2">)</span>
                <span class="s1">child_scope </span><span class="s2">= {</span><span class="s4">&quot;path_params&quot;</span><span class="s2">: </span><span class="s1">path_params</span><span class="s2">, </span><span class="s4">&quot;endpoint&quot;</span><span class="s2">: </span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span><span class="s2">}</span>
                <span class="s0">return </span><span class="s1">Match</span><span class="s2">.</span><span class="s1">FULL</span><span class="s2">, </span><span class="s1">child_scope</span>
        <span class="s0">return </span><span class="s1">Match</span><span class="s2">.</span><span class="s1">NONE</span><span class="s2">, {}</span>

    <span class="s0">def </span><span class="s1">url_path_for</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, /, **</span><span class="s1">path_params</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; URLPath</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">is not None and </span><span class="s1">name </span><span class="s2">== </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">and </span><span class="s4">&quot;path&quot; </span><span class="s0">in </span><span class="s1">path_params</span><span class="s2">:</span>
            <span class="s6"># 'name' matches &quot;&lt;mount_name&gt;&quot;.</span>
            <span class="s1">path </span><span class="s2">= </span><span class="s1">path_params</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s4">&quot;path&quot;</span><span class="s2">)</span>
            <span class="s1">host</span><span class="s2">, </span><span class="s1">remaining_params </span><span class="s2">= </span><span class="s1">replace_params</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">host_format</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors</span><span class="s2">, </span><span class="s1">path_params</span><span class="s2">)</span>
            <span class="s0">if not </span><span class="s1">remaining_params</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">URLPath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">=</span><span class="s1">path</span><span class="s2">, </span><span class="s1">host</span><span class="s2">=</span><span class="s1">host</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">is None or </span><span class="s1">name</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s2">+ </span><span class="s4">&quot;:&quot;</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s6"># No mount name.</span>
                <span class="s1">remaining_name </span><span class="s2">= </span><span class="s1">name</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s6"># 'name' matches &quot;&lt;mount_name&gt;:&lt;child_name&gt;&quot;.</span>
                <span class="s1">remaining_name </span><span class="s2">= </span><span class="s1">name</span><span class="s2">[</span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">name</span><span class="s2">) + </span><span class="s5">1 </span><span class="s2">:]</span>
            <span class="s1">host</span><span class="s2">, </span><span class="s1">remaining_params </span><span class="s2">= </span><span class="s1">replace_params</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">host_format</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">param_convertors</span><span class="s2">, </span><span class="s1">path_params</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">route </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">routes </span><span class="s0">or </span><span class="s2">[]:</span>
                <span class="s0">try</span><span class="s2">:</span>
                    <span class="s1">url </span><span class="s2">= </span><span class="s1">route</span><span class="s2">.</span><span class="s1">url_path_for</span><span class="s2">(</span><span class="s1">remaining_name</span><span class="s2">, **</span><span class="s1">remaining_params</span><span class="s2">)</span>
                    <span class="s0">return </span><span class="s1">URLPath</span><span class="s2">(</span><span class="s1">path</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">url</span><span class="s2">), </span><span class="s1">protocol</span><span class="s2">=</span><span class="s1">url</span><span class="s2">.</span><span class="s1">protocol</span><span class="s2">, </span><span class="s1">host</span><span class="s2">=</span><span class="s1">host</span><span class="s2">)</span>
                <span class="s0">except </span><span class="s1">NoMatchFound</span><span class="s2">:</span>
                    <span class="s0">pass</span>
        <span class="s0">raise </span><span class="s1">NoMatchFound</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">path_params</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">handle</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">Host</span><span class="s2">) </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">host </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">host </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">app </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">app</span>

    <span class="s0">def </span><span class="s1">__repr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; str</span><span class="s2">:</span>
        <span class="s1">class_name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span>
        <span class="s1">name </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">name </span><span class="s0">or </span><span class="s4">&quot;&quot;</span>
        <span class="s0">return </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">class_name</span><span class="s0">}</span><span class="s4">(host=</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">host</span><span class="s0">!r}</span><span class="s4">, name=</span><span class="s0">{</span><span class="s1">name</span><span class="s0">!r}</span><span class="s4">, app=</span><span class="s0">{</span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span><span class="s0">!r}</span><span class="s4">)&quot;</span>


<span class="s1">_T </span><span class="s2">= </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">TypeVar</span><span class="s2">(</span><span class="s4">&quot;_T&quot;</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">_AsyncLiftContextManager</span><span class="s2">(</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">AsyncContextManager</span><span class="s2">[</span><span class="s1">_T</span><span class="s2">]):</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cm</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">ContextManager</span><span class="s2">[</span><span class="s1">_T</span><span class="s2">]):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_cm </span><span class="s2">= </span><span class="s1">cm</span>

    <span class="s0">async def </span><span class="s1">__aenter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; _T</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cm</span><span class="s2">.</span><span class="s1">__enter__</span><span class="s2">()</span>

    <span class="s0">async def </span><span class="s1">__aexit__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">exc_type</span><span class="s2">: </span><span class="s1">type</span><span class="s2">[</span><span class="s1">BaseException</span><span class="s2">] | </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">exc_value</span><span class="s2">: </span><span class="s1">BaseException </span><span class="s2">| </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">traceback</span><span class="s2">: </span><span class="s1">types</span><span class="s2">.</span><span class="s1">TracebackType </span><span class="s2">| </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; bool </span><span class="s2">| </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_cm</span><span class="s2">.</span><span class="s1">__exit__</span><span class="s2">(</span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_value</span><span class="s2">, </span><span class="s1">traceback</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_wrap_gen_lifespan_context</span><span class="s2">(</span>
    <span class="s1">lifespan_context</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">[[</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">], </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Generator</span><span class="s2">[</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">, </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">, </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]],</span>
<span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">[[</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">], </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">AsyncContextManager</span><span class="s2">[</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]]:</span>
    <span class="s1">cmgr </span><span class="s2">= </span><span class="s1">contextlib</span><span class="s2">.</span><span class="s1">contextmanager</span><span class="s2">(</span><span class="s1">lifespan_context</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">functools</span><span class="s2">.</span><span class="s1">wraps</span><span class="s2">(</span><span class="s1">cmgr</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">wrapper</span><span class="s2">(</span><span class="s1">app</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; _AsyncLiftContextManager</span><span class="s2">[</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]:</span>
        <span class="s0">return </span><span class="s1">_AsyncLiftContextManager</span><span class="s2">(</span><span class="s1">cmgr</span><span class="s2">(</span><span class="s1">app</span><span class="s2">))</span>

    <span class="s0">return </span><span class="s1">wrapper</span>


<span class="s0">class </span><span class="s1">_DefaultLifespan</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">router</span><span class="s2">: </span><span class="s1">Router</span><span class="s2">):</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">_router </span><span class="s2">= </span><span class="s1">router</span>

    <span class="s0">async def </span><span class="s1">__aenter__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_router</span><span class="s2">.</span><span class="s1">startup</span><span class="s2">()</span>

    <span class="s0">async def </span><span class="s1">__aexit__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">exc_info</span><span class="s2">: </span><span class="s1">object</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_router</span><span class="s2">.</span><span class="s1">shutdown</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">: </span><span class="s1">_T</span><span class="s2">, </span><span class="s1">app</span><span class="s2">: </span><span class="s1">object</span><span class="s2">) </span><span class="s1">-&gt; _T</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">self</span>


<span class="s0">class </span><span class="s1">Router</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">routes</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Sequence</span><span class="s2">[</span><span class="s1">BaseRoute</span><span class="s2">] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">redirect_slashes</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
        <span class="s1">default</span><span class="s2">: </span><span class="s1">ASGIApp </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">on_startup</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Sequence</span><span class="s2">[</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">[[], </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">on_shutdown</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Sequence</span><span class="s2">[</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">[[], </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s6"># the generic to Lifespan[AppType] is the type of the top level application</span>
        <span class="s6"># which the router cannot know statically, so we use typing.Any</span>
        <span class="s1">lifespan</span><span class="s2">: </span><span class="s1">Lifespan</span><span class="s2">[</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">*,</span>
        <span class="s1">middleware</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Sequence</span><span class="s2">[</span><span class="s1">Middleware</span><span class="s2">] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">routes </span><span class="s2">= [] </span><span class="s0">if </span><span class="s1">routes </span><span class="s0">is None else </span><span class="s1">list</span><span class="s2">(</span><span class="s1">routes</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">redirect_slashes </span><span class="s2">= </span><span class="s1">redirect_slashes</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">default </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">not_found </span><span class="s0">if </span><span class="s1">default </span><span class="s0">is None else </span><span class="s1">default</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">on_startup </span><span class="s2">= [] </span><span class="s0">if </span><span class="s1">on_startup </span><span class="s0">is None else </span><span class="s1">list</span><span class="s2">(</span><span class="s1">on_startup</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">on_shutdown </span><span class="s2">= [] </span><span class="s0">if </span><span class="s1">on_shutdown </span><span class="s0">is None else </span><span class="s1">list</span><span class="s2">(</span><span class="s1">on_shutdown</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">on_startup </span><span class="s0">or </span><span class="s1">on_shutdown</span><span class="s2">:</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
                <span class="s4">&quot;The on_startup and on_shutdown parameters are deprecated, and they &quot;</span>
                <span class="s4">&quot;will be removed on version 1.0. Use the lifespan parameter instead. &quot;</span>
                <span class="s4">&quot;See more about it on https://www.starlette.io/lifespan/.&quot;</span><span class="s2">,</span>
                <span class="s1">DeprecationWarning</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">if </span><span class="s1">lifespan</span><span class="s2">:</span>
                <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
                    <span class="s4">&quot;The `lifespan` parameter cannot be used with `on_startup` or &quot;</span>
                    <span class="s4">&quot;`on_shutdown`. Both `on_startup` and `on_shutdown` will be &quot;</span>
                    <span class="s4">&quot;ignored.&quot;</span>
                <span class="s2">)</span>

        <span class="s0">if </span><span class="s1">lifespan </span><span class="s0">is None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lifespan_context</span><span class="s2">: </span><span class="s1">Lifespan</span><span class="s2">[</span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">] = </span><span class="s1">_DefaultLifespan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">)</span>

        <span class="s0">elif </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">isasyncgenfunction</span><span class="s2">(</span><span class="s1">lifespan</span><span class="s2">):</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
                <span class="s4">&quot;async generator function lifespans are deprecated, &quot;</span>
                <span class="s4">&quot;use an @contextlib.asynccontextmanager function instead&quot;</span><span class="s2">,</span>
                <span class="s1">DeprecationWarning</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lifespan_context </span><span class="s2">= </span><span class="s1">asynccontextmanager</span><span class="s2">(</span>
                <span class="s1">lifespan</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s0">elif </span><span class="s1">inspect</span><span class="s2">.</span><span class="s1">isgeneratorfunction</span><span class="s2">(</span><span class="s1">lifespan</span><span class="s2">):</span>
            <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
                <span class="s4">&quot;generator function lifespans are deprecated, use an @contextlib.asynccontextmanager function instead&quot;</span><span class="s2">,</span>
                <span class="s1">DeprecationWarning</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lifespan_context </span><span class="s2">= </span><span class="s1">_wrap_gen_lifespan_context</span><span class="s2">(</span>
                <span class="s1">lifespan</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">lifespan_context </span><span class="s2">= </span><span class="s1">lifespan</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">middleware_stack </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">app</span>
        <span class="s0">if </span><span class="s1">middleware</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">cls</span><span class="s2">, </span><span class="s1">args</span><span class="s2">, </span><span class="s1">kwargs </span><span class="s0">in </span><span class="s1">reversed</span><span class="s2">(</span><span class="s1">middleware</span><span class="s2">):</span>
                <span class="s1">self</span><span class="s2">.</span><span class="s1">middleware_stack </span><span class="s2">= </span><span class="s1">cls</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">middleware_stack</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">not_found</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] == </span><span class="s4">&quot;websocket&quot;</span><span class="s2">:</span>
            <span class="s1">websocket_close </span><span class="s2">= </span><span class="s1">WebSocketClose</span><span class="s2">()</span>
            <span class="s0">await </span><span class="s1">websocket_close</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>
            <span class="s0">return</span>

        <span class="s6"># If we're running inside a starlette application then raise an</span>
        <span class="s6"># exception, so that the configurable exception handler can deal with</span>
        <span class="s6"># returning the response. For plain ASGI apps, just return the response.</span>
        <span class="s0">if </span><span class="s4">&quot;app&quot; </span><span class="s0">in </span><span class="s1">scope</span><span class="s2">:</span>
            <span class="s0">raise </span><span class="s1">HTTPException</span><span class="s2">(</span><span class="s1">status_code</span><span class="s2">=</span><span class="s5">404</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">response </span><span class="s2">= </span><span class="s1">PlainTextResponse</span><span class="s2">(</span><span class="s4">&quot;Not Found&quot;</span><span class="s2">, </span><span class="s1">status_code</span><span class="s2">=</span><span class="s5">404</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">response</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">url_path_for</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, /, **</span><span class="s1">path_params</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; URLPath</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">route </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">routes</span><span class="s2">:</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">route</span><span class="s2">.</span><span class="s1">url_path_for</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, **</span><span class="s1">path_params</span><span class="s2">)</span>
            <span class="s0">except </span><span class="s1">NoMatchFound</span><span class="s2">:</span>
                <span class="s0">pass</span>
        <span class="s0">raise </span><span class="s1">NoMatchFound</span><span class="s2">(</span><span class="s1">name</span><span class="s2">, </span><span class="s1">path_params</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">startup</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot; 
        Run any `.on_startup` event handlers. 
        &quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">handler </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_startup</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">is_async_callable</span><span class="s2">(</span><span class="s1">handler</span><span class="s2">):</span>
                <span class="s0">await </span><span class="s1">handler</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">handler</span><span class="s2">()</span>

    <span class="s0">async def </span><span class="s1">shutdown</span><span class="s2">(</span><span class="s1">self</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot; 
        Run any `.on_shutdown` event handlers. 
        &quot;&quot;&quot;</span>
        <span class="s0">for </span><span class="s1">handler </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">on_shutdown</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">is_async_callable</span><span class="s2">(</span><span class="s1">handler</span><span class="s2">):</span>
                <span class="s0">await </span><span class="s1">handler</span><span class="s2">()</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">handler</span><span class="s2">()</span>

    <span class="s0">async def </span><span class="s1">lifespan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot; 
        Handle ASGI lifespan messages, which allows us to manage application 
        startup and shutdown events. 
        &quot;&quot;&quot;</span>
        <span class="s1">started </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">app</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any </span><span class="s2">= </span><span class="s1">scope</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;app&quot;</span><span class="s2">)</span>
        <span class="s0">await </span><span class="s1">receive</span><span class="s2">()</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">async with </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lifespan_context</span><span class="s2">(</span><span class="s1">app</span><span class="s2">) </span><span class="s0">as </span><span class="s1">maybe_state</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">maybe_state </span><span class="s0">is not None</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s4">&quot;state&quot; </span><span class="s0">not in </span><span class="s1">scope</span><span class="s2">:</span>
                        <span class="s0">raise </span><span class="s1">RuntimeError</span><span class="s2">(</span><span class="s4">'The server does not support &quot;state&quot; in the lifespan scope.'</span><span class="s2">)</span>
                    <span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;state&quot;</span><span class="s2">].</span><span class="s1">update</span><span class="s2">(</span><span class="s1">maybe_state</span><span class="s2">)</span>
                <span class="s0">await </span><span class="s1">send</span><span class="s2">({</span><span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;lifespan.startup.complete&quot;</span><span class="s2">})</span>
                <span class="s1">started </span><span class="s2">= </span><span class="s0">True</span>
                <span class="s0">await </span><span class="s1">receive</span><span class="s2">()</span>
        <span class="s0">except </span><span class="s1">BaseException</span><span class="s2">:</span>
            <span class="s1">exc_text </span><span class="s2">= </span><span class="s1">traceback</span><span class="s2">.</span><span class="s1">format_exc</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">started</span><span class="s2">:</span>
                <span class="s0">await </span><span class="s1">send</span><span class="s2">({</span><span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;lifespan.shutdown.failed&quot;</span><span class="s2">, </span><span class="s4">&quot;message&quot;</span><span class="s2">: </span><span class="s1">exc_text</span><span class="s2">})</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">await </span><span class="s1">send</span><span class="s2">({</span><span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;lifespan.startup.failed&quot;</span><span class="s2">, </span><span class="s4">&quot;message&quot;</span><span class="s2">: </span><span class="s1">exc_text</span><span class="s2">})</span>
            <span class="s0">raise</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">send</span><span class="s2">({</span><span class="s4">&quot;type&quot;</span><span class="s2">: </span><span class="s4">&quot;lifespan.shutdown.complete&quot;</span><span class="s2">})</span>

    <span class="s0">async def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s3">&quot;&quot;&quot; 
        The main entry point to the Router class. 
        &quot;&quot;&quot;</span>
        <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">middleware_stack</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>

    <span class="s0">async def </span><span class="s1">app</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">scope</span><span class="s2">: </span><span class="s1">Scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">: </span><span class="s1">Receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">: </span><span class="s1">Send</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;http&quot;</span><span class="s2">, </span><span class="s4">&quot;websocket&quot;</span><span class="s2">, </span><span class="s4">&quot;lifespan&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s4">&quot;router&quot; </span><span class="s0">not in </span><span class="s1">scope</span><span class="s2">:</span>
            <span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;router&quot;</span><span class="s2">] = </span><span class="s1">self</span>

        <span class="s0">if </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] == </span><span class="s4">&quot;lifespan&quot;</span><span class="s2">:</span>
            <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">lifespan</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>
            <span class="s0">return</span>

        <span class="s1">partial </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s0">for </span><span class="s1">route </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">routes</span><span class="s2">:</span>
            <span class="s6"># Determine if any route matches the incoming scope,</span>
            <span class="s6"># and hand over to the matching route if found.</span>
            <span class="s1">match</span><span class="s2">, </span><span class="s1">child_scope </span><span class="s2">= </span><span class="s1">route</span><span class="s2">.</span><span class="s1">matches</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">match </span><span class="s2">== </span><span class="s1">Match</span><span class="s2">.</span><span class="s1">FULL</span><span class="s2">:</span>
                <span class="s1">scope</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">child_scope</span><span class="s2">)</span>
                <span class="s0">await </span><span class="s1">route</span><span class="s2">.</span><span class="s1">handle</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>
                <span class="s0">return</span>
            <span class="s0">elif </span><span class="s1">match </span><span class="s2">== </span><span class="s1">Match</span><span class="s2">.</span><span class="s1">PARTIAL </span><span class="s0">and </span><span class="s1">partial </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s1">partial </span><span class="s2">= </span><span class="s1">route</span>
                <span class="s1">partial_scope </span><span class="s2">= </span><span class="s1">child_scope</span>

        <span class="s0">if </span><span class="s1">partial </span><span class="s0">is not None</span><span class="s2">:</span>
            <span class="s6">#  Handle partial matches. These are cases where an endpoint is</span>
            <span class="s6"># able to handle the request, but is not a preferred option.</span>
            <span class="s6"># We use this in particular to deal with &quot;405 Method Not Allowed&quot;.</span>
            <span class="s1">scope</span><span class="s2">.</span><span class="s1">update</span><span class="s2">(</span><span class="s1">partial_scope</span><span class="s2">)</span>
            <span class="s0">await </span><span class="s1">partial</span><span class="s2">.</span><span class="s1">handle</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>
            <span class="s0">return</span>

        <span class="s1">route_path </span><span class="s2">= </span><span class="s1">get_route_path</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">scope</span><span class="s2">[</span><span class="s4">&quot;type&quot;</span><span class="s2">] == </span><span class="s4">&quot;http&quot; </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">redirect_slashes </span><span class="s0">and </span><span class="s1">route_path </span><span class="s2">!= </span><span class="s4">&quot;/&quot;</span><span class="s2">:</span>
            <span class="s1">redirect_scope </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">route_path</span><span class="s2">.</span><span class="s1">endswith</span><span class="s2">(</span><span class="s4">&quot;/&quot;</span><span class="s2">):</span>
                <span class="s1">redirect_scope</span><span class="s2">[</span><span class="s4">&quot;path&quot;</span><span class="s2">] = </span><span class="s1">redirect_scope</span><span class="s2">[</span><span class="s4">&quot;path&quot;</span><span class="s2">].</span><span class="s1">rstrip</span><span class="s2">(</span><span class="s4">&quot;/&quot;</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">redirect_scope</span><span class="s2">[</span><span class="s4">&quot;path&quot;</span><span class="s2">] = </span><span class="s1">redirect_scope</span><span class="s2">[</span><span class="s4">&quot;path&quot;</span><span class="s2">] + </span><span class="s4">&quot;/&quot;</span>

            <span class="s0">for </span><span class="s1">route </span><span class="s0">in </span><span class="s1">self</span><span class="s2">.</span><span class="s1">routes</span><span class="s2">:</span>
                <span class="s1">match</span><span class="s2">, </span><span class="s1">child_scope </span><span class="s2">= </span><span class="s1">route</span><span class="s2">.</span><span class="s1">matches</span><span class="s2">(</span><span class="s1">redirect_scope</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">match </span><span class="s2">!= </span><span class="s1">Match</span><span class="s2">.</span><span class="s1">NONE</span><span class="s2">:</span>
                    <span class="s1">redirect_url </span><span class="s2">= </span><span class="s1">URL</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">=</span><span class="s1">redirect_scope</span><span class="s2">)</span>
                    <span class="s1">response </span><span class="s2">= </span><span class="s1">RedirectResponse</span><span class="s2">(</span><span class="s1">url</span><span class="s2">=</span><span class="s1">str</span><span class="s2">(</span><span class="s1">redirect_url</span><span class="s2">))</span>
                    <span class="s0">await </span><span class="s1">response</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>
                    <span class="s0">return</span>

        <span class="s0">await </span><span class="s1">self</span><span class="s2">.</span><span class="s1">default</span><span class="s2">(</span><span class="s1">scope</span><span class="s2">, </span><span class="s1">receive</span><span class="s2">, </span><span class="s1">send</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">__eq__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">other</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">other</span><span class="s2">, </span><span class="s1">Router</span><span class="s2">) </span><span class="s0">and </span><span class="s1">self</span><span class="s2">.</span><span class="s1">routes </span><span class="s2">== </span><span class="s1">other</span><span class="s2">.</span><span class="s1">routes</span>

    <span class="s0">def </span><span class="s1">mount</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">app</span><span class="s2">: </span><span class="s1">ASGIApp</span><span class="s2">, </span><span class="s1">name</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:  </span><span class="s6"># pragma: no cover</span>
        <span class="s1">route </span><span class="s2">= </span><span class="s1">Mount</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">app</span><span class="s2">=</span><span class="s1">app</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">routes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">route</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">host</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">host</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">app</span><span class="s2">: </span><span class="s1">ASGIApp</span><span class="s2">, </span><span class="s1">name</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:  </span><span class="s6"># pragma: no cover</span>
        <span class="s1">route </span><span class="s2">= </span><span class="s1">Host</span><span class="s2">(</span><span class="s1">host</span><span class="s2">, </span><span class="s1">app</span><span class="s2">=</span><span class="s1">app</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">routes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">route</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">add_route</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
        <span class="s1">endpoint</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">[[</span><span class="s1">Request</span><span class="s2">], </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Awaitable</span><span class="s2">[</span><span class="s1">Response</span><span class="s2">] | </span><span class="s1">Response</span><span class="s2">],</span>
        <span class="s1">methods</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">include_in_schema</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:  </span><span class="s6"># pragma: no cover</span>
        <span class="s1">route </span><span class="s2">= </span><span class="s1">Route</span><span class="s2">(</span>
            <span class="s1">path</span><span class="s2">,</span>
            <span class="s1">endpoint</span><span class="s2">=</span><span class="s1">endpoint</span><span class="s2">,</span>
            <span class="s1">methods</span><span class="s2">=</span><span class="s1">methods</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
            <span class="s1">include_in_schema</span><span class="s2">=</span><span class="s1">include_in_schema</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">routes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">route</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">add_websocket_route</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
        <span class="s1">endpoint</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">[[</span><span class="s1">WebSocket</span><span class="s2">], </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Awaitable</span><span class="s2">[</span><span class="s0">None</span><span class="s2">]],</span>
        <span class="s1">name</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:  </span><span class="s6"># pragma: no cover</span>
        <span class="s1">route </span><span class="s2">= </span><span class="s1">WebSocketRoute</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">endpoint</span><span class="s2">=</span><span class="s1">endpoint</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">routes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">route</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">route</span><span class="s2">(</span>
        <span class="s1">self</span><span class="s2">,</span>
        <span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
        <span class="s1">methods</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">str</span><span class="s2">] | </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s1">include_in_schema</span><span class="s2">: </span><span class="s1">bool </span><span class="s2">= </span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">:  </span><span class="s6"># type: ignore[type-arg]</span>
        <span class="s3">&quot;&quot;&quot; 
        We no longer document this decorator style API, and its usage is discouraged. 
        Instead you should use the following approach: 
 
        &gt;&gt;&gt; routes = [Route(path, endpoint=...), ...] 
        &gt;&gt;&gt; app = Starlette(routes=routes) 
        &quot;&quot;&quot;</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
            <span class="s4">&quot;The `route` decorator is deprecated, and will be removed in version 1.0.0.&quot;</span>
            <span class="s4">&quot;Refer to https://www.starlette.io/routing/#http-routing for the recommended approach.&quot;</span><span class="s2">,</span>
            <span class="s1">DeprecationWarning</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s0">def </span><span class="s1">decorator</span><span class="s2">(</span><span class="s1">func</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">:  </span><span class="s6"># type: ignore[type-arg]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">add_route</span><span class="s2">(</span>
                <span class="s1">path</span><span class="s2">,</span>
                <span class="s1">func</span><span class="s2">,</span>
                <span class="s1">methods</span><span class="s2">=</span><span class="s1">methods</span><span class="s2">,</span>
                <span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">,</span>
                <span class="s1">include_in_schema</span><span class="s2">=</span><span class="s1">include_in_schema</span><span class="s2">,</span>
            <span class="s2">)</span>
            <span class="s0">return </span><span class="s1">func</span>

        <span class="s0">return </span><span class="s1">decorator</span>

    <span class="s0">def </span><span class="s1">websocket_route</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">name</span><span class="s2">: </span><span class="s1">str </span><span class="s2">| </span><span class="s0">None </span><span class="s2">= </span><span class="s0">None</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">:  </span><span class="s6"># type: ignore[type-arg]</span>
        <span class="s3">&quot;&quot;&quot; 
        We no longer document this decorator style API, and its usage is discouraged. 
        Instead you should use the following approach: 
 
        &gt;&gt;&gt; routes = [WebSocketRoute(path, endpoint=...), ...] 
        &gt;&gt;&gt; app = Starlette(routes=routes) 
        &quot;&quot;&quot;</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
            <span class="s4">&quot;The `websocket_route` decorator is deprecated, and will be removed in version 1.0.0. Refer to &quot;</span>
            <span class="s4">&quot;https://www.starlette.io/routing/#websocket-routing for the recommended approach.&quot;</span><span class="s2">,</span>
            <span class="s1">DeprecationWarning</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s0">def </span><span class="s1">decorator</span><span class="s2">(</span><span class="s1">func</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">:  </span><span class="s6"># type: ignore[type-arg]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">add_websocket_route</span><span class="s2">(</span><span class="s1">path</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">name</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">func</span>

        <span class="s0">return </span><span class="s1">decorator</span>

    <span class="s0">def </span><span class="s1">add_event_handler</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event_type</span><span class="s2">: </span><span class="s1">str</span><span class="s2">, </span><span class="s1">func</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">[[], </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Any</span><span class="s2">]) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:  </span><span class="s6"># pragma: no cover</span>
        <span class="s0">assert </span><span class="s1">event_type </span><span class="s0">in </span><span class="s2">(</span><span class="s4">&quot;startup&quot;</span><span class="s2">, </span><span class="s4">&quot;shutdown&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">event_type </span><span class="s2">== </span><span class="s4">&quot;startup&quot;</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">on_startup</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">func</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">on_shutdown</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">func</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">on_event</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">event_type</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">:  </span><span class="s6"># type: ignore[type-arg]</span>
        <span class="s1">warnings</span><span class="s2">.</span><span class="s1">warn</span><span class="s2">(</span>
            <span class="s4">&quot;The `on_event` decorator is deprecated, and will be removed in version 1.0.0. &quot;</span>
            <span class="s4">&quot;Refer to https://www.starlette.io/lifespan/ for recommended approach.&quot;</span><span class="s2">,</span>
            <span class="s1">DeprecationWarning</span><span class="s2">,</span>
        <span class="s2">)</span>

        <span class="s0">def </span><span class="s1">decorator</span><span class="s2">(</span><span class="s1">func</span><span class="s2">: </span><span class="s1">typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">) </span><span class="s1">-&gt; typing</span><span class="s2">.</span><span class="s1">Callable</span><span class="s2">:  </span><span class="s6"># type: ignore[type-arg]</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">add_event_handler</span><span class="s2">(</span><span class="s1">event_type</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">func</span>

        <span class="s0">return </span><span class="s1">decorator</span>
</pre>
</body>
</html>